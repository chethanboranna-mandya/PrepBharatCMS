<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Markdown to Json Converter</title>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']],
                displayMath: [['$$', '$$'], ['\\[', '\\]']]
            }
        };
    </script>
    
    <!-- Firebase Configuration -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import {
            getStorage,
            ref,
            uploadBytesResumable,
            getDownloadURL,
            deleteObject
        } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-storage.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDkRSU7sVKQXmQo4C-imX0aSeHXHhlH59E",
            authDomain: "prepbharat.firebaseapp.com",
            projectId: "prepbharat",
            storageBucket: "prepbharat.firebasestorage.app",
            messagingSenderId: "593555148862",
            appId: "1:593555148862:web:d627edfe32a17c71a5c16f",
            measurementId: "G-7QGE8KDDTF"
        };
        
        const app = initializeApp(firebaseConfig);
        const storage = getStorage(app);

        // Make firebase functions available globally
        window.firebaseStorage = {
            storage,
            ref,
            deleteObject,
            uploadBytesResumable,
            getDownloadURL
        };

        // Firebase upload function with progress tracking
        window.uploadImageToFirebase = function(file, subject, year, index, suffix, onProgress) {
            return new Promise((resolve, reject) => {
                const fileName = `${subject.toLowerCase()}_${year}_${index + 1}${suffix}`;
                const storageRef = ref(storage, `questions/${subject}/${year}/${fileName}`);
                const uploadTask = uploadBytesResumable(storageRef, file);

                uploadTask.on(
                    "state_changed",
                    (snapshot) => {
                        const percent = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                        if (onProgress) onProgress(Math.round(percent));
                    },
                    (error) => reject(error),
                    () => {
                        getDownloadURL(uploadTask.snapshot.ref).then(resolve).catch(reject);
                    }
                );
            });
        };
    </script>
    <style>
        :root {
            --primary-color: #2563eb;
            --primary-hover: #1d4ed8;
            --secondary-color: #64748b;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --error-color: #ef4444;
            --background-color: #f8fafc;
            --surface-color: #ffffff;
            --border-color: #e2e8f0;
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --text-muted: #94a3b8;
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            --radius-sm: 0.375rem;
            --radius-md: 0.5rem;
            --radius-lg: 0.75rem;
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            overflow-x: hidden;
            color: var(--text-primary);
            line-height: 1.6;
        }
        
        .container {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            max-width: 1800px;
            margin: 20px auto;
            background: var(--surface-color);
            box-shadow: var(--shadow-lg);
            border-radius: var(--radius-lg);
            overflow: hidden;
        }
        
        .sidebar {
            width: 100%;
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-hover) 100%);
            color: white;
            padding: 24px;
            box-shadow: var(--shadow-md);
            position: relative;
            z-index: 1000;
            box-sizing: border-box;
        }
        
        /* Custom scrollbar for sidebar */
        .sidebar::-webkit-scrollbar {
            width: 6px;
        }
        
        .sidebar::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
        }
        
        .sidebar::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.3);
            border-radius: 3px;
        }
        
        .sidebar::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.5);
        }
        
        .sidebar-header {
            text-align: center;
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 1px solid rgba(255,255,255,0.2);
        }
        
        .sidebar-header h1 {
            margin: 0;
            font-size: 24px;
            font-weight: 700;
            letter-spacing: -0.025em;
        }
        
        .sidebar-header p {
            margin: 8px 0 0 0;
            font-size: 14px;
            opacity: 0.9;
            font-weight: 400;
        }
        
        .sidebar-content {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            align-items: flex-start;
        }
        
        .sidebar-section {
            flex: 1;
            min-width: 200px;
        }
        
        .upload-section {
            background: rgba(255, 255, 255, 0.15);
            padding: 20px;
            border-radius: var(--radius-lg);
            border: 1px solid rgba(255, 255, 255, 0.25);
            backdrop-filter: blur(20px);
            box-shadow: var(--shadow-sm);
        }
        
        .upload-section h3 {
            margin: 0 0 10px 0;
            font-size: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .upload-section p {
            margin: 0 0 15px 0;
            font-size: 13px;
            opacity: 0.9;
            line-height: 1.4;
        }
        
        .main-content {
            flex: 1;
            padding: 32px;
            background: var(--background-color);
            min-height: auto;
            max-width: 100%;
            overflow-x: hidden;
            box-sizing: border-box;
        }
        
        
        /* Responsive design */
        @media (max-width: 768px) {
            .sidebar-content {
                flex-direction: column;
            }
            
            .sidebar-section {
                min-width: 100%;
            }
            
            .subject-tabs-sidebar {
                flex-direction: column;
            }
        }
        
        .file-input {
            display: none;
        }
        
        .upload-btn {
            background: linear-gradient(135deg, var(--success-color) 0%, #059669 100%);
            color: white;
            border: none;
            padding: 14px 28px;
            border-radius: var(--radius-md);
            cursor: pointer;
            font-size: 15px;
            font-weight: 600;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            width: 100%;
            margin-top: 12px;
            box-shadow: var(--shadow-sm);
            letter-spacing: 0.025em;
        }
        
        .upload-btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
            background: linear-gradient(135deg, #059669 0%, var(--success-color) 100%);
        }
        
        .upload-btn:active {
            transform: translateY(0);
            box-shadow: var(--shadow-sm);
        }
        
        
        .sidebar-subjects {
            margin-top: 0;
        }
        
        .subject-tabs-sidebar {
            display: flex;
            flex-direction: row;
            gap: 8px;
            flex-wrap: wrap;
        }
        
        .subject-tab-sidebar {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            color: rgba(255, 255, 255, 0.8);
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
            text-align: left;
            width: 100%;
        }
        
        .subject-tab-sidebar:hover {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            transform: translateX(5px);
        }
        
        .subject-tab-sidebar.active {
            background: rgba(79, 172, 254, 0.2);
            color: #4facfe;
            border-color: rgba(79, 172, 254, 0.3);
            border-left: 3px solid #4facfe;
        }
        
        .subject-tab-sidebar span:first-child {
            font-size: 16px;
        }
        
        .question-count {
            background: rgba(79, 172, 254, 0.2);
            color: #4facfe;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            margin-left: auto;
        }
        
        .sidebar-stats {
            margin-top: 20px;
        }
        
        .stats-summary {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 12px;
        }
        
        .stat-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            font-size: 13px;
        }
        
        .stat-item:last-child {
            margin-bottom: 0;
        }
        
        .stat-label {
            color: rgba(255, 255, 255, 0.8);
        }
        
        .stat-number {
            background: rgba(79, 172, 254, 0.2);
            color: #4facfe;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            min-width: 20px;
            text-align: center;
        }
        
        .sidebar-download {
            margin-top: 20px;
        }
        
        .download-buttons {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .download-btn, .download-all-btn {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            color: rgba(255, 255, 255, 0.8);
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
            text-align: left;
            width: 100%;
        }
        
        .download-btn:hover {
            background: rgba(79, 172, 254, 0.1);
            color: #4facfe;
            border-color: rgba(79, 172, 254, 0.3);
            transform: translateX(3px);
        }
        
        .download-all-btn {
            background: rgba(39, 174, 96, 0.1);
            border-color: rgba(39, 174, 96, 0.2);
            color: #27ae60;
            margin-top: 8px;
        }
        
        .download-all-btn:hover {
            background: rgba(39, 174, 96, 0.2);
            border-color: rgba(39, 174, 96, 0.4);
            color: #2ecc71;
            transform: translateX(3px);
        }
        
        .download-icon {
            margin-left: auto;
            font-size: 16px;
        }
        
        
        
        .questions-container {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
            min-height: auto;
            box-sizing: border-box;
            max-width: 100%;
        }
        
        .questions-grid {
            flex: 1;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
        }
        
        .questions-list {
            display: grid;
            grid-template-columns: 150px 2fr 1fr;
            gap: 24px;
            width: 100%;
            max-width: 100%;
            box-sizing: border-box;
            overflow: visible;
            background: var(--surface-color);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-sm);
            padding: 24px;
        }
        
        .question-list-sidebar {
            background: var(--background-color);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            padding: 20px;
            max-height: 70vh;
            overflow-y: auto;
            width: 150px;
            min-width: 150px;
            max-width: 150px;
            box-sizing: border-box;
            box-shadow: var(--shadow-sm);
        }
        
        .question-list-sidebar h4 {
            margin: 0 0 15px 0;
            color: #495057;
            font-size: 16px;
            font-weight: 600;
            border-bottom: 1px solid #dee2e6;
            padding-bottom: 10px;
        }
        
        .question-item {
            display: block;
            width: 100%;
            padding: 12px 16px;
            margin-bottom: 8px;
            background: var(--surface-color);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
            text-align: center;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-weight: 600;
            color: var(--text-primary);
            box-shadow: var(--shadow-sm);
        }
        
        .question-item:hover {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }
        
        .question-item.active {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
            box-shadow: var(--shadow-md);
        }
        
        .question-editor-panel {
            background: var(--surface-color);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            padding: 32px;
            max-height: 80vh;
            overflow-y: auto;
            overflow-x: visible;
            box-sizing: border-box;
            width: 100%;
            max-width: 100%;
            min-width: 0;
            display: flex;
            flex-direction: column;
            position: relative;
            box-shadow: var(--shadow-sm);
        }
        
        .question-render-panel {
            background: var(--surface-color);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            padding: 32px;
            max-height: 80vh;
            overflow-y: auto;
            overflow-x: hidden;
            box-sizing: border-box;
            width: 100%;
            max-width: 100%;
            min-width: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            box-shadow: var(--shadow-sm);
        }
        
        .question-render-item {
            width: 100%;
            margin-bottom: 32px;
            padding: 24px;
            border: 2px solid var(--border-color);
            border-radius: var(--radius-lg);
            background: var(--surface-color);
            transition: all 0.3s ease;
        }
        
        .question-render-item.active-question {
            border-color: var(--primary-color);
            background: linear-gradient(135deg, rgba(37, 99, 235, 0.05) 0%, rgba(37, 99, 235, 0.02) 100%);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }
        
        .question-render-item h5 {
            margin: 0 0 16px 0;
            color: var(--text-primary);
            font-size: 18px;
            font-weight: 700;
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 8px;
        }
        
        .question-render-item.active-question h5 {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
        }
        
        .question-render-item .question-text {
            font-size: 16px;
            line-height: 1.6;
            margin-bottom: 16px;
            color: var(--text-primary);
        }
        
        .question-render-item .options {
            margin: 16px 0;
        }
        
        .question-render-item .option {
            margin: 8px 0;
            padding: 8px 12px;
            background: var(--background-color);
            border-radius: var(--radius-sm);
            border-left: 3px solid var(--border-color);
        }
        
        .question-render-item .answer {
            margin: 16px 0;
            padding: 12px 16px;
            background: linear-gradient(135deg, var(--success-color), #059669);
            color: white;
            border-radius: var(--radius-md);
            font-weight: 600;
        }
        
        .question-render-item .solution {
            margin-top: 16px;
            padding: 16px;
            background: var(--background-color);
            border-radius: var(--radius-md);
            border-left: 4px solid var(--primary-color);
        }
        
        .question-render-item .solution strong {
            color: var(--primary-color);
            font-size: 16px;
        }
        
        .question-editor-panel h4,
        .question-render-panel h4 {
            margin: 0 0 15px 0;
            color: #495057;
            font-size: 16px;
            font-weight: 600;
            border-bottom: 1px solid #dee2e6;
            padding-bottom: 10px;
        }
        
        /* JSON Viewer Styles */
        .viewer-toggle {
            display: flex;
            gap: 2px;
            padding: 2px;
            background: var(--background-color);
            border-radius: var(--radius-md);
            border: 1px solid var(--border-color);
        }
        
        .inline-panels-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 6px 16px;
            background: var(--surface-color);
            border-bottom: 1px solid var(--border-color);
            min-height: 40px;
        }
        
        .inline-panels-header h3 {
            margin: 0;
            color: var(--text-primary);
            font-size: 14px;
            font-weight: 600;
        }
        
        .viewer-toggle-btn {
            flex: 1;
            padding: 4px 8px;
            border: none;
            border-radius: var(--radius-sm);
            background: transparent;
            color: var(--text-secondary);
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            min-height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .viewer-toggle-btn.active {
            background: var(--primary-color);
            color: white;
            box-shadow: var(--shadow-sm);
        }
        
        .viewer-toggle-btn:hover:not(.active) {
            background: var(--background-color);
            color: var(--text-primary);
        }
        
        .json-viewer-panel {
            background: var(--surface-color);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            padding: 32px;
            max-height: 80vh;
            overflow-y: auto;
            overflow-x: hidden;
            box-sizing: border-box;
            width: 100%;
            max-width: 100%;
            min-width: 0;
            display: none;
            flex-direction: column;
            position: relative;
            box-shadow: var(--shadow-sm);
        }
        
        .json-viewer-panel.active {
            display: flex;
        }
        
        .json-viewer-panel h4 {
            margin: 0 0 20px 0;
            color: var(--text-primary);
            font-size: 18px;
            font-weight: 700;
            border-bottom: 2px solid var(--primary-color);
            padding-bottom: 12px;
        }
        
        .json-content {
            background: #1e293b;
            color: #e2e8f0;
            padding: 24px;
            border-radius: var(--radius-md);
            font-family: 'JetBrains Mono', 'Fira Code', 'Consolas', monospace;
            font-size: 14px;
            line-height: 1.7;
            overflow-x: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
            border: 1px solid #334155;
            max-height: 50vh;
            overflow-y: auto;
            min-height: 300px;
        }
        
        .json-content::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        .json-content::-webkit-scrollbar-track {
            background: #334155;
            border-radius: 4px;
        }
        
        .json-content::-webkit-scrollbar-thumb {
            background: #64748b;
            border-radius: 4px;
        }
        
        .json-content::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
        
        .json-actions {
            margin-top: 16px;
            display: flex;
            gap: 12px;
        }
        
        .json-action-btn {
            padding: 10px 20px;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
            background: var(--surface-color);
            color: var(--text-primary);
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .json-action-btn:hover {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }
        
        .json-action-btn.primary {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }
        
        .json-action-btn.primary:hover {
            background: var(--primary-hover);
        }
        
        .question-edit-item {
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }
        
        .question-edit-item h5 {
            margin: 0 0 20px 0;
            color: #495057;
            font-size: 18px;
            font-weight: 600;
        }
        
        .edit-field {
            margin-bottom: 20px;
            width: 100%;
            box-sizing: border-box;
            max-width: 100%;
            min-width: 0;
            overflow: visible;
        }
        
        .edit-field label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #495057;
            text-align: left;
        }
        
        .question-edit-input {
            width: 100%;
            min-height: 180px;
            padding: 16px;
            border: 2px solid var(--border-color);
            border-radius: var(--radius-md);
            font-size: 15px;
            font-family: inherit;
            resize: vertical;
            box-sizing: border-box;
            max-width: 100%;
            overflow-x: hidden;
            word-wrap: break-word;
            background: var(--surface-color);
            color: var(--text-primary);
            transition: all 0.3s ease;
        }
        
        .question-edit-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }
        
        .option-edit-input {
            width: 100%;
            min-height: 50px;
            padding: 12px 16px;
            border: 2px solid var(--border-color);
            border-radius: var(--radius-md);
            font-size: 15px;
            font-family: inherit;
            box-sizing: border-box;
            max-width: 100%;
            overflow-x: hidden;
            word-wrap: break-word;
            resize: vertical;
            background: var(--surface-color);
            color: var(--text-primary);
            transition: all 0.3s ease;
        }
        
        .option-edit-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }
        
        .solution-edit-input {
            width: 100%;
            min-height: 150px;
            padding: 16px;
            border: 2px solid var(--border-color);
            border-radius: var(--radius-md);
            font-size: 15px;
            font-family: inherit;
            resize: vertical;
            box-sizing: border-box;
            max-width: 100%;
            overflow-x: hidden;
            word-wrap: break-word;
            background: var(--surface-color);
            color: var(--text-primary);
            transition: all 0.3s ease;
        }
        
        .solution-edit-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }
        
        .answer-edit-select {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid var(--border-color);
            border-radius: var(--radius-md);
            font-size: 15px;
            font-family: inherit;
            background: var(--surface-color);
            color: var(--text-primary);
            box-sizing: border-box;
            max-width: 100%;
            transition: all 0.3s ease;
        }
        
        .answer-edit-select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }
        
        .option-edit-item {
            display: flex;
            flex-direction: column;
            margin-bottom: 15px;
            width: 100%;
            box-sizing: border-box;
            max-width: 100%;
        }
        
        .option-edit-item label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #495057;
            text-align: left !important;
            width: 100%;
            text-align-last: left;
        }
        
        .options-edit-grid {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 20px;
            width: 100%;
        }
        
        .render-panel {
            flex: 1;
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 10px;
            padding: 15px;
            position: relative;
            box-sizing: border-box;
            max-width: 100%;
        }
        
        .render-label {
            position: absolute;
            top: -12px;
            right: 0px;
            background: white;
            padding: 2px 12px;
            font-size: 12px;
            color: #666;
            font-weight: 500;
            z-index: 1;
            white-space: nowrap;
        }
        
        .render-header {
            display: none;
        }
        
        .question-card {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            background: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            cursor: pointer;
            transition: all 0.2s ease;
            min-height: 150px;
            max-height: 250px;
            margin-bottom: 15px;
            overflow-y: auto;
            box-sizing: border-box;
        }
        
        .question-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
            border-color: #4facfe;
        }
        
        .question-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .question-number {
            background: #4facfe;
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            font-weight: bold;
        }
        
        .subject-selector {
            padding: 5px 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background: white;
        }
        
        .question-text {
            margin-bottom: 10px;
            line-height: 1.4;
            color: #333;
            word-wrap: break-word;
            overflow-wrap: break-word;
            max-height: 100px;
            overflow-y: auto;
        }
        
        .question-options {
            margin-bottom: 10px;
            max-height: 80px;
            overflow-y: auto;
        }
        
        .option {
            margin: 3px 0;
            padding: 3px 8px;
            background: #f8f9fa;
            border-radius: 3px;
            font-size: 14px;
        }
        
        .answer {
            font-weight: bold;
            color: #28a745;
            margin-top: 5px;
        }
        
        .actions {
            text-align: center;
            margin-top: 30px;
        }
        
        .btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 0 10px;
        }
        
        .btn:hover {
            background: #218838;
        }
        
        .btn-secondary {
            background: #6c757d;
        }
        
        .btn-secondary:hover {
            background: #5a6268;
        }
        
        .subject-assignments {
            margin-top: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 5px;
        }
        
        .subject-group {
            margin: 10px 0;
        }
        
        .subject-title {
            font-weight: bold;
            color: #4facfe;
            margin-bottom: 5px;
        }
        
        .question-list {
            color: #666;
            font-size: 14px;
        }
        
        
        .subject-questions {
            display: none;
        }
        
        .subject-questions.active {
            display: block;
        }
        
        .subject-view {
            display: none;
        }
        
        .subject-view.active {
            display: block;
        }
        
        .split-container {
            display: flex;
            gap: 20px;
            height: 70vh;
            margin-top: 20px;
        }
        
        .json-panel {
            flex: 1;
            background: #f8f9fa;
            border: 1px solid #e0e0e0;
            border-radius: 10px;
            padding: 20px;
            overflow-y: auto;
        }
        
        .render-panel {
            flex: 1;
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 10px;
            padding: 15px;
            position: relative;
            box-sizing: border-box;
        }
        
        .render-label {
            position: absolute;
            top: -12px;
            right: 0px;
            background: white;
            padding: 2px 12px;
            font-size: 12px;
            color: #666;
            font-weight: 500;
            z-index: 1;
            white-space: nowrap;
        }
        
        .render-header {
            display: none;
        }
        
        .json-header {
            background: #4facfe;
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            text-align: center;
        }
        
        .render-header {
            background: #28a745;
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            text-align: center;
        }
        
        .question-render {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .question-render h4 {
            color: #4facfe;
            margin-bottom: 10px;
        }
        
        .options-render {
            margin: 10px 0;
        }
        
        .option-render {
            margin: 5px 0;
            padding: 8px;
            background: #f8f9fa;
            border-radius: 5px;
        }
        
        .answer-render {
            color: #28a745;
            font-weight: bold;
            margin-top: 10px;
        }
        
        .solution-render {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 15px;
            margin: 15px 0;
            color: #495057;
            line-height: 1.6;
        }
        
        .solution {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 10px;
            margin: 10px 0;
            color: #495057;
            line-height: 1.4;
            font-size: 14px;
        }
        
        .json-display {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 10px;
            font-family: 'Courier New', monospace;
            max-height: calc(100vh - 300px);
            overflow-y: auto;
            box-sizing: border-box;
            position: relative;
        }
        
        .json-display h4 {
            margin: 0 0 15px 0;
            color: #495057;
            font-size: 16px;
        }
        
        .json-display pre {
            background: #ffffff;
            border: 1px solid #e9ecef;
            border-radius: 5px;
            padding: 15px;
            margin: 0;
            overflow-x: auto;
            overflow-y: auto;
            font-size: 11px;
            line-height: 1.3;
            max-height: calc(100vh - 200px);
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        
        .json-display code {
            color: #212529;
            font-family: 'Courier New', monospace;
        }
        
        .json-container {
            flex: 1;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        .metadata-editor {
            background: var(--surface-color);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: var(--shadow-sm);
        }
        
        .metadata-editor h2 {
            margin: 0 0 20px 0;
            color: var(--text-primary);
            font-size: 20px;
            font-weight: 700;
        }
        
        .row {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .field {
            flex: 1;
            min-width: 200px;
        }
        
        .field label {
            display: block;
            margin-bottom: 4px;
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .field input, .field select {
            margin: 4px 0;
            padding: 6px;
            width: 100%;
            box-sizing: border-box;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
            background: var(--surface-color);
            color: var(--text-primary);
        }
        
        .field input:focus, .field select:focus {
            outline: none;
            border-color: var(--primary-color);
        }
        
        .field input[readonly] {
            background: var(--background-color);
            color: var(--text-secondary);
            cursor: not-allowed;
        }
        
        .metadata-editor > label {
            display: block;
            margin-bottom: 4px;
            font-weight: 600;
            color: var(--text-primary);
            margin-top: 16px;
        }
        
        .metadata-editor > input {
            margin: 4px 0;
            padding: 6px;
            width: 100%;
            box-sizing: border-box;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
            background: var(--surface-color);
            color: var(--text-primary);
        }
        
        .metadata-editor > input:focus {
            outline: none;
            border-color: var(--primary-color);
        }
        
        /* Side by side layout for Tutorial Title and Authority Exam ID */
        .metadata-editor .row:last-of-type {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .metadata-editor .row:last-of-type .field {
            flex: 0 0 auto;
            width: 300px;
            max-width: 300px;
        }
        
        .form-input:hover {
            border-color: #adb5bd;
        }
        
        .question-actions {
            display: flex;
            gap: 10px;
        }
        
        .edit-btn {
            background: #4facfe;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: background 0.3s ease;
        }
        
        .edit-btn:hover {
            background: #00f2fe;
        }
        
        .question-content {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .question-textarea {
            width: 100%;
            min-height: 80px;
            padding: 10px;
            border: 1px solid #ced4da;
            border-radius: 6px;
            font-size: 14px;
            font-family: inherit;
            resize: vertical;
            box-sizing: border-box;
        }
        
        .question-textarea:focus {
            outline: none;
            border-color: #4facfe;
            box-shadow: 0 0 0 3px rgba(79, 172, 254, 0.1);
        }
        
        .option-input {
            flex: 1;
            padding: 5px 8px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 14px;
            margin-left: 5px;
        }
        
        .option-input:focus {
            outline: none;
            border-color: #4facfe;
            box-shadow: 0 0 0 2px rgba(79, 172, 254, 0.1);
        }
        
        .answer-section, .solution-section {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .answer-section label, .solution-section label {
            font-weight: 600;
            color: #495057;
            font-size: 14px;
        }
        
        .answer-select {
            padding: 8px 12px;
            border: 1px solid #ced4da;
            border-radius: 6px;
            font-size: 14px;
            background: white;
            cursor: pointer;
        }
        
        .answer-select:focus {
            outline: none;
            border-color: #4facfe;
            box-shadow: 0 0 0 3px rgba(79, 172, 254, 0.1);
        }
        
        .solution-textarea {
            width: 100%;
            min-height: 100px;
            padding: 10px;
            border: 1px solid #ced4da;
            border-radius: 6px;
            font-size: 14px;
            font-family: inherit;
            resize: vertical;
            box-sizing: border-box;
        }
        
        .solution-textarea:focus {
            outline: none;
            border-color: #4facfe;
            box-shadow: 0 0 0 3px rgba(79, 172, 254, 0.1);
        }
        
        
        
        .question-edit-item {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }
        
        .question-edit-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #4facfe;
        }
        
        .question-edit-number {
            font-size: 18px;
            font-weight: bold;
            color: #4facfe;
        }
        
        .question-edit-fields {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .edit-field-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .edit-field-group label {
            font-weight: 600;
            color: #495057;
            font-size: 14px;
        }
        
        .edit-field-group input,
        .edit-field-group textarea,
        .edit-field-group select {
            padding: 10px;
            border: 1px solid #ced4da;
            border-radius: 6px;
            font-size: 14px;
            font-family: inherit;
        }
        
        .edit-field-group input:focus,
        .edit-field-group textarea:focus,
        .edit-field-group select:focus {
            outline: none;
            border-color: #4facfe;
            box-shadow: 0 0 0 3px rgba(79, 172, 254, 0.1);
        }
        
        .edit-field-group textarea {
            resize: vertical;
            min-height: 80px;
        }
        
        .options-edit-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        
        .option-edit-item {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        
        .inline-edit-interface {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        
        
        .inline-panels-header {
            padding: 15px 20px;
            background: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
        }
        
        .inline-panels-header h3 {
            margin: 0;
            color: #495057;
            font-size: 18px;
            font-weight: 600;
        }
        
        .edit-interface-content {
            display: flex;
            min-height: auto;
            gap: 20px;
        }
        
        .edit-fields-container {
            flex: 1;
            border-right: 1px solid #dee2e6;
            padding: 20px;
        }
        
        .inline-render-view {
            flex: 1;
            padding: 20px;
            background: #f8f9fa;
        }
        
        .inline-render-view h4 {
            margin: 0 0 15px 0;
            color: #495057;
            font-size: 18px;
        }
        
        .edit-questions-list {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .tab-controls {
            display: flex;
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 4px;
            margin-bottom: 20px;
            width: fit-content;
        }
        
        .tab-segment {
            padding: 8px 20px;
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            color: #6c757d;
            transition: all 0.2s ease;
            user-select: none;
        }
        
        .tab-segment:first-child {
            border-top-right-radius: 0;
            border-bottom-right-radius: 0;
            border-right: none;
        }
        
        .tab-segment:last-child {
            border-top-left-radius: 0;
            border-bottom-left-radius: 0;
        }
        
        .tab-segment.active {
            background: #4facfe;
            color: white;
            border-color: #4facfe;
            box-shadow: 0 2px 4px rgba(79, 172, 254, 0.2);
        }
        
        .tab-segment:hover:not(.active) {
            background: #e9ecef;
            color: #495057;
        }
        
        .json-view-container {
            flex: 1;
            border-right: 1px solid #dee2e6;
            padding: 20px;
        }
        
        .json-view-container .json-display {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            height: 100%;
        }
        
        .json-view-container .json-display h4 {
            margin: 0 0 15px 0;
            color: #495057;
            font-size: 16px;
        }
        
        .json-textarea {
            width: 100%;
            min-height: 300px;
            background: #ffffff;
            border: 1px solid #e9ecef;
            border-radius: 5px;
            padding: 15px;
            margin: 0;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            line-height: 1.4;
            resize: none;
            white-space: pre-wrap;
            overflow-x: hidden;
            overflow-y: auto;
            word-wrap: break-word;
            box-sizing: border-box;
        }
        
        .json-textarea:focus {
            outline: none;
            border-color: #4facfe;
            box-shadow: 0 0 0 3px rgba(79, 172, 254, 0.1);
        }
        
        /* Image Upload Styles */
        .image-upload-area {
            border: 2px dashed #dee2e6;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            background: #f8f9fa;
            margin: 10px 0;
            transition: all 0.3s ease;
            cursor: pointer;
            width: 60%;
            box-sizing: border-box;
            max-width: 60%;
            align-self: flex-start;
        }
        
        .image-upload-area:hover {
            border-color: #4facfe;
            background: #e3f2fd;
        }
        
        .image-upload-area.dragover {
            border-color: #4facfe;
            background: #e3f2fd;
            transform: scale(1.02);
        }
        
        .image-upload-icon {
            font-size: 24px;
            color: #6c757d;
            margin-bottom: 10px;
        }
        
        .image-upload-text {
            color: #6c757d;
            font-size: 14px;
            margin-bottom: 5px;
        }
        
        .image-upload-hint {
            color: #adb5bd;
            font-size: 12px;
        }
        
        .uploaded-images {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 15px;
        }
        
        .uploaded-image {
            position: relative;
            width: 80px;
            height: 80px;
            border-radius: 8px;
            overflow: hidden;
            border: 2px solid #e9ecef;
        }
        
        .uploaded-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .remove-image {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Progress Bar Styles */
        .upload-progress {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 8px 0;
            padding: 8px;
            background: #f8f9fa;
            border-radius: 4px;
            border: 1px solid #e9ecef;
        }

        .progress-bar {
            flex: 1;
            height: 8px;
            background: #e9ecef;
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #007bff, #0056b3);
            border-radius: 4px;
            transition: width 0.3s ease;
            width: 0%;
        }

        .progress-text {
            font-size: 12px;
            color: #6c757d;
            min-width: 50px;
            text-align: right;
        }

        .upload-status {
            font-size: 12px;
            font-weight: 500;
        }

        .upload-status.uploading {
            color: #007bff;
        }

        .upload-status.success {
            color: #28a745;
        }

        .upload-status.error {
            color: #dc3545;
        }
        
        .option-image-upload {
            margin-top: 8px;
            width: 100%;
            box-sizing: border-box;
            max-width: 100%;
        }
        
        .image-upload-section {
            margin-bottom: 20px;
            width: 100%;
        }
        
        .image-upload-section label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #495057;
            text-align: left;
        }
        
        .image-upload-area {
            width: 100%;
            min-height: 80px;
            border: 2px dashed #dee2e6;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: #f8f9fa;
            box-sizing: border-box;
        }
        
        .option-image-upload .image-upload-area {
            padding: 15px;
            margin: 0;
            min-height: 60px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        
        .option-image-upload .image-upload-icon {
            font-size: 16px;
            margin-bottom: 4px;
        }
        
        .option-image-upload .image-upload-text {
            font-size: 11px;
            margin-bottom: 2px;
        }
        
        .option-image-upload .image-upload-hint {
            font-size: 10px;
        }
        
        .option-image-upload .uploaded-image {
            width: 50px;
            height: 50px;
        }
        
        .option-edit-item {
            display: flex;
            flex-direction: column;
            margin-bottom: 15px;
        }
        
        
        .option-edit-input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 14px;
            margin-bottom: 8px;
        }
        
        .options-edit-grid {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Left Sidebar -->
        <div class="sidebar">
            <div class="sidebar-header">
                <h1>📚 Markdown to Json Converter</h1>
                <p>Professional Question Management</p>
        </div>
        
            <div class="sidebar-content">
                <div class="sidebar-section">
        <div class="upload-section">
                        <h3>📁 Upload File</h3>
                        <p>Select your markdown file containing questions to get started</p>
            <input type="file" id="fileInput" class="file-input" accept=".md,.txt">
            <button class="upload-btn" onclick="document.getElementById('fileInput').click()">
                Choose File
            </button>
                    </div>
        </div>
        
                <div class="sidebar-section">
                    <!-- Subject Tabs in Sidebar -->
                    <div class="sidebar-subjects" id="sidebarSubjectTabs" style="display: none;">
                        <h3 style="margin: 0 0 15px 0; font-size: 16px; color: rgba(255,255,255,0.9);">📚 Subjects</h3>
                        <div class="subject-tabs-sidebar">
                            <button class="subject-tab-sidebar active" onclick="showSubject('Mathematics')" id="sidebar-tab-Mathematics">
                                <span>🔢</span>
                                <span>Mathematics</span>
                                <span class="question-count" id="sidebar-count-Mathematics">0</span>
                            </button>
                            <button class="subject-tab-sidebar" onclick="showSubject('Physics')" id="sidebar-tab-Physics">
                                <span>⚛️</span>
                                <span>Physics</span>
                                <span class="question-count" id="sidebar-count-Physics">0</span>
                            </button>
                            <button class="subject-tab-sidebar" onclick="showSubject('Chemistry')" id="sidebar-tab-Chemistry">
                                <span>🧪</span>
                                <span>Chemistry</span>
                                <span class="question-count" id="sidebar-count-Chemistry">0</span>
                            </button>
            </div>
            </div>
            </div>
            
            <!-- Statistics Summary in Sidebar -->
                <div class="sidebar-section">
                    <div class="sidebar-stats" id="sidebarStats" style="display: none;">
                        <h3 style="margin: 0 0 15px 0; font-size: 16px; color: rgba(255,255,255,0.9);">📊 Summary</h3>
                        <div class="stats-summary">
                            <div class="stat-item">
                                <span class="stat-label">Total Questions</span>
                                <span class="stat-number" id="sidebar-total-questions">0</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">Extracted</span>
                                <span class="stat-number" id="sidebar-extracted-questions">0</span>
                            </div>
                        </div>
            </div>
        </div>

                <div class="sidebar-section">
                    <!-- Download Section in Sidebar -->
                    <div class="sidebar-download" id="sidebarDownload" style="display: none;">
                        <h3 style="margin: 0 0 15px 0; font-size: 16px; color: rgba(255,255,255,0.9);">💾 Download JSON</h3>
                        <div class="download-buttons">
                            <button class="download-btn" onclick="downloadSubjectJSON('Mathematics')" id="download-math">
                                <span>🔢</span>
                                <span>Mathematics</span>
                                <span class="download-icon">⬇️</span>
                            </button>
                            <button class="download-btn" onclick="downloadSubjectJSON('Physics')" id="download-physics">
                                <span>⚛️</span>
                                <span>Physics</span>
                                <span class="download-icon">⬇️</span>
                            </button>
                            <button class="download-btn" onclick="downloadSubjectJSON('Chemistry')" id="download-chemistry">
                                <span>🧪</span>
                                <span>Chemistry</span>
                                <span class="download-icon">⬇️</span>
                            </button>
                            <button class="download-all-btn" onclick="downloadAllSubjectsJSON()">
                                <span>📦</span>
                                <span>Download All</span>
                                <span class="download-icon">⬇️</span>
                            </button>
                        </div>
                    </div>
            </div>
        </div>
            
        </div>
        
        <!-- Main Content Area -->
        <div class="main-content">
        

        
        <div id="questionsContainer" style="display: none;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3>📋 JSON Viewer</h3>
                <h3>📖 Render View</h3>
            </div>
            <div class="questions-container">
                <div class="questions-grid">
                    <div class="questions-list" id="questionsList">
                        <!-- Questions will be populated here -->
                    </div>
                </div>
                <div class="render-panel">
                    <div id="allQuestionsRender">
                        <p>Select a question to view its rendered content with MathJax.</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Subject Views -->
        <div id="subjectView-Mathematics" class="subject-view">
            
            <!-- Metadata Editor Section -->
            <div class="metadata-editor">
                <h2>Tutorial JSON Builder</h2>
                <div class="row">
                    <div class="field">
                        <label>State:</label>
                        <select id="state">
                            <option value="Karnataka" selected>Karnataka</option>
                            <option value="Maharashtra">Maharashtra</option>
                            <option value="Tamil Nadu">Tamil Nadu</option>
                            <option value="Center">Center</option>
                        </select>
                        </div>
                    <div class="field">
                        <label>Board:</label>
                        <select id="board">
                            <option value="KCET" selected>KCET</option>
                            <option value="NEET">NEET</option>
                            <option value="JEE Main">JEE Main</option>
                            <option value="JEE Advanced">JEE Advanced</option>
                            <option value="MH-CET">MH-CET</option>
                            <option value="TN-Board">TN-Board</option>
                        </select>
                        </div>
                    <div class="field">
                        <label>Conducted By:</label>
                        <input type="text" id="conductedBy" value="KEA (Karnataka Examinations Authority)" readonly />
                    </div>
                    <div class="field">
                        <label>Year:</label>
                        <select id="year">
                            <option value="2025" selected>2025</option>
                            <option value="2024">2024</option>
                            <option value="2023">2023</option>
                            <option value="2022">2022</option>
                            <option value="2021">2021</option>
                        </select>
                        </div>
                    <div class="field">
                        <label>Subject:</label>
                        <select id="subject">
                            <option value="Mathematics" selected>Mathematics</option>
                            <option value="Physics">Physics</option>
                            <option value="Chemistry">Chemistry</option>
                            <option value="Biology">Biology</option>
                        </select>
                    </div>
                    <div class="field">
                        <label>Tutorial ID:</label>
                        <input type="text" id="tutorialId" value="KCET_2025_Mathematics" readonly/>
                        </div>
                        </div>
                <div class="row">
                    <div class="field">
                        <label>Tutorial Title:</label>
                        <input type="text" id="tutorialTitle" value="KCET 2025 Mathematics"/>
                    </div>
                    <div class="field">
                        <label>Authority Exam ID:</label>
                        <input type="text" id="authorityExamId" value="kar_kect"/>
                    </div>
                </div>
            </div>
            
            
            <!-- Always show edit interface for Mathematics -->
            <div id="inlineEditInterface-Mathematics" class="inline-edit-interface">
                <div class="inline-panels-header">
                    <h3>Question Editor</h3>
                    <!-- Viewer Toggle -->
                    <div class="viewer-toggle" id="viewerToggle-Mathematics" style="display: none;">
                        <button class="viewer-toggle-btn active" onclick="switchViewer('Mathematics', 'editor')">✏️ Question Editor</button>
                        <button class="viewer-toggle-btn" onclick="switchViewer('Mathematics', 'json')">📄 JSON Viewer</button>
                    </div>
                </div>
                <div class="edit-interface-content">
                    <div class="question-list-sidebar" id="questionList-Mathematics">
                        <h4>📋 Questions</h4>
                        <!-- Question list will be populated here -->
                    </div>
                    
                    <!-- Question Editor Panel -->
                    <div class="question-editor-panel" id="questionEditor-Mathematics" style="display: none;">
                        <h4>✏️ Question Editor</h4>
                        <div id="editQuestionsList-Mathematics">
                            <!-- Editable question fields will be populated here -->
                        </div>
                    </div>
                    
                    <!-- JSON Viewer Panel -->
                    <div class="json-viewer-panel" id="jsonViewer-Mathematics" style="display: none;">
                        <h4>📄 JSON Data Structure</h4>
                        <div class="json-content" id="jsonContent-Mathematics">
                            <!-- JSON content will be populated here -->
                        </div>
                        <div class="json-actions">
                            <button class="json-action-btn primary" onclick="copyJSON('Mathematics')">📋 Copy JSON</button>
                            <button class="json-action-btn" onclick="downloadJSON('Mathematics')">💾 Download JSON</button>
                            <button class="json-action-btn" onclick="refreshJSON('Mathematics')">🔄 Refresh</button>
                    </div>
                    </div>
                    
                    <div class="question-render-panel" id="questionRender-Mathematics" style="display: none;">
                        <h4>📖 Live Preview</h4>
                        <div id="inlineMathRender">
                            <!-- Live render view will be shown here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="subjectView-Physics" class="subject-view">
            
            <!-- Metadata Editor Section -->
            <div class="metadata-editor">
                <h2>Tutorial JSON Builder</h2>
                <div class="row">
                    <div class="field">
                        <label>State:</label>
                        <select id="state-physics">
                            <option value="Karnataka" selected>Karnataka</option>
                            <option value="Maharashtra">Maharashtra</option>
                            <option value="Tamil Nadu">Tamil Nadu</option>
                            <option value="Center">Center</option>
                        </select>
                        </div>
                    <div class="field">
                        <label>Board:</label>
                        <select id="board-physics">
                            <option value="KCET" selected>KCET</option>
                            <option value="NEET">NEET</option>
                            <option value="JEE Main">JEE Main</option>
                            <option value="JEE Advanced">JEE Advanced</option>
                            <option value="MH-CET">MH-CET</option>
                            <option value="TN-Board">TN-Board</option>
                        </select>
                        </div>
                    <div class="field">
                        <label>Conducted By:</label>
                        <input type="text" id="conductedBy-physics" value="KEA (Karnataka Examinations Authority)" readonly />
                    </div>
                    <div class="field">
                        <label>Year:</label>
                        <select id="year-physics">
                            <option value="2025" selected>2025</option>
                            <option value="2024">2024</option>
                            <option value="2023">2023</option>
                            <option value="2022">2022</option>
                            <option value="2021">2021</option>
                        </select>
                        </div>
                    <div class="field">
                        <label>Subject:</label>
                        <select id="subject-physics">
                            <option value="Mathematics">Mathematics</option>
                            <option value="Physics" selected>Physics</option>
                            <option value="Chemistry">Chemistry</option>
                            <option value="Biology">Biology</option>
                        </select>
                    </div>
                    <div class="field">
                        <label>Tutorial ID:</label>
                        <input type="text" id="tutorialId-physics" value="KCET_2025_Physics" readonly/>
                        </div>
                        </div>
                <div class="row">
                    <div class="field">
                        <label>Tutorial Title:</label>
                        <input type="text" id="tutorialTitle-physics" value="KCET 2025 Physics"/>
                    </div>
                    <div class="field">
                        <label>Authority Exam ID:</label>
                        <input type="text" id="authorityExamId-physics" value="kar_kect"/>
                    </div>
                </div>
            </div>
            
            
            <!-- Always show edit interface for Physics -->
            <div id="inlineEditInterface-Physics" class="inline-edit-interface">
                <div class="inline-panels-header">
                    <h3>Question Editor</h3>
                    <!-- Viewer Toggle -->
                    <div class="viewer-toggle" id="viewerToggle-Physics" style="display: none;">
                        <button class="viewer-toggle-btn active" onclick="switchViewer('Physics', 'editor')">✏️ Question Editor</button>
                        <button class="viewer-toggle-btn" onclick="switchViewer('Physics', 'json')">📄 JSON Viewer</button>
                    </div>
                </div>
                <div class="edit-interface-content">
                    <div class="question-list-sidebar" id="questionList-Physics">
                        <h4>📋 Questions</h4>
                        <!-- Question list will be populated here -->
                    </div>
                    
                    <!-- Question Editor Panel -->
                    <div class="question-editor-panel" id="questionEditor-Physics" style="display: none;">
                        <h4>✏️ Question Editor</h4>
                        <div id="editQuestionsList-Physics">
                            <!-- Editable question fields will be populated here -->
                        </div>
                    </div>
                    
                    <!-- JSON Viewer Panel -->
                    <div class="json-viewer-panel" id="jsonViewer-Physics" style="display: none;">
                        <h4>📄 JSON Data Structure</h4>
                        <div class="json-content" id="jsonContent-Physics">
                            <!-- JSON content will be populated here -->
                        </div>
                        <div class="json-actions">
                            <button class="json-action-btn primary" onclick="copyJSON('Physics')">📋 Copy JSON</button>
                            <button class="json-action-btn" onclick="downloadJSON('Physics')">💾 Download JSON</button>
                            <button class="json-action-btn" onclick="refreshJSON('Physics')">🔄 Refresh</button>
                    </div>
                    </div>
                    
                    <div class="question-render-panel" id="questionRender-Physics" style="display: none;">
                        <h4>📖 Live Preview</h4>
                        <div id="inlinePhysicsRender">
                            <!-- Live render view will be shown here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="subjectView-Chemistry" class="subject-view">
            
            <!-- Metadata Editor Section -->
            <div class="metadata-editor">
                <h2>Tutorial JSON Builder</h2>
                <div class="row">
                    <div class="field">
                        <label>State:</label>
                        <select id="state-chemistry">
                            <option value="Karnataka" selected>Karnataka</option>
                            <option value="Maharashtra">Maharashtra</option>
                            <option value="Tamil Nadu">Tamil Nadu</option>
                            <option value="Center">Center</option>
                        </select>
                        </div>
                    <div class="field">
                        <label>Board:</label>
                        <select id="board-chemistry">
                            <option value="KCET" selected>KCET</option>
                            <option value="NEET">NEET</option>
                            <option value="JEE Main">JEE Main</option>
                            <option value="JEE Advanced">JEE Advanced</option>
                            <option value="MH-CET">MH-CET</option>
                            <option value="TN-Board">TN-Board</option>
                        </select>
                        </div>
                    <div class="field">
                        <label>Conducted By:</label>
                        <input type="text" id="conductedBy-chemistry" value="KEA (Karnataka Examinations Authority)" readonly />
                    </div>
                    <div class="field">
                        <label>Year:</label>
                        <select id="year-chemistry">
                            <option value="2025" selected>2025</option>
                            <option value="2024">2024</option>
                            <option value="2023">2023</option>
                            <option value="2022">2022</option>
                            <option value="2021">2021</option>
                        </select>
                        </div>
                    <div class="field">
                        <label>Subject:</label>
                        <select id="subject-chemistry">
                            <option value="Mathematics">Mathematics</option>
                            <option value="Physics">Physics</option>
                            <option value="Chemistry" selected>Chemistry</option>
                            <option value="Biology">Biology</option>
                        </select>
                    </div>
                    <div class="field">
                        <label>Tutorial ID:</label>
                        <input type="text" id="tutorialId-chemistry" value="KCET_2025_Chemistry" readonly/>
                        </div>
                        </div>
                <div class="row">
                    <div class="field">
                        <label>Tutorial Title:</label>
                        <input type="text" id="tutorialTitle-chemistry" value="KCET 2025 Chemistry"/>
                    </div>
                    <div class="field">
                        <label>Authority Exam ID:</label>
                        <input type="text" id="authorityExamId-chemistry" value="kar_kect"/>
                    </div>
                </div>
            </div>
            
            
            <!-- Always show edit interface for Chemistry -->
            <div id="inlineEditInterface-Chemistry" class="inline-edit-interface">
                <div class="inline-panels-header">
                    <h3>Question Editor</h3>
                    <!-- Viewer Toggle -->
                    <div class="viewer-toggle" id="viewerToggle-Chemistry" style="display: none;">
                        <button class="viewer-toggle-btn active" onclick="switchViewer('Chemistry', 'editor')">✏️ Question Editor</button>
                        <button class="viewer-toggle-btn" onclick="switchViewer('Chemistry', 'json')">📄 JSON Viewer</button>
                    </div>
                </div>
                <div class="edit-interface-content">
                    <div class="question-list-sidebar" id="questionList-Chemistry">
                        <h4>📋 Questions</h4>
                        <!-- Question list will be populated here -->
                    </div>
                    
                    <!-- Question Editor Panel -->
                    <div class="question-editor-panel" id="questionEditor-Chemistry" style="display: none;">
                        <h4>✏️ Question Editor</h4>
                        <div id="editQuestionsList-Chemistry">
                            <!-- Editable question fields will be populated here -->
                        </div>
                    </div>
                    
                    <!-- JSON Viewer Panel -->
                    <div class="json-viewer-panel" id="jsonViewer-Chemistry" style="display: none;">
                        <h4>📄 JSON Data Structure</h4>
                        <div class="json-content" id="jsonContent-Chemistry">
                            <!-- JSON content will be populated here -->
                        </div>
                        <div class="json-actions">
                            <button class="json-action-btn primary" onclick="copyJSON('Chemistry')">📋 Copy JSON</button>
                            <button class="json-action-btn" onclick="downloadJSON('Chemistry')">💾 Download JSON</button>
                            <button class="json-action-btn" onclick="refreshJSON('Chemistry')">🔄 Refresh</button>
                    </div>
                    </div>
                    
                    <div class="question-render-panel" id="questionRender-Chemistry" style="display: none;">
                        <h4>📖 Live Preview</h4>
                        <div id="inlineChemistryRender">
                            <!-- Live render view will be shown here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        
    </div>


    <script>
        let allQuestions = [];
        let questionAssignments = {};
        
        document.getElementById('fileInput').addEventListener('change', handleFileSelect);
        
        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const content = e.target.result;
                    parseQuestions(content);
                };
                reader.readAsText(file);
            }
        }
        
        // Function to clean image tags and URLs from text
        function cleanImageReferences(text) {
            if (!text) return text;
            
            // Remove HTML img tags (both self-closing and with closing tag)
            text = text.replace(/<img[^>]*\/?>/gi, '[Image]');
            
            // Remove markdown image syntax ![](url)
            text = text.replace(/!\[\]\([^)]+\)/g, '[Image]');
            
            // Remove markdown image syntax ![alt](url)
            text = text.replace(/!\[[^\]]*\]\([^)]+\)/g, '[Image]');
            
            // Remove any remaining image URLs (http/https)
            text = text.replace(/https?:\/\/[^\s]+\.(jpg|jpeg|png|gif|svg|webp|bmp)(\?[^\s]*)?/gi, '[Image]');
            
            // Remove data URLs (base64 images)
            text = text.replace(/data:image\/[^;]+;base64,[A-Za-z0-9+/=]+/g, '[Image]');
            
            // Clean up multiple consecutive [Image] placeholders
            text = text.replace(/\[Image\]\s*\[Image\]/g, '[Image]');
            
            // Clean up extra whitespace
            text = text.replace(/\s+/g, ' ').trim();
            
            return text;
        }
        
        function parseQuestions(content) {
            console.log('Parsing questions from content...');
            
            const lines = content.split('\n');
            const questions = [];
            let currentQuestion = null;
            let currentSubject = '';
            // Subject activation only after pattern: ## <Subject> then ## SECTION-A
            let pendingSubject = '';
            let inSubjectSection = false;
            let debugContent = '';
            let inSolution = false;
            // Option capture state for inline options like "... (1) ... (2) ..."
            let inOptionCapture = false;
            let currentOptionNumber = 0;
            // Track when we're in a Quick Tip section to skip content
            let inQuickTip = false;
            
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i].trim();
                
                // Skip empty lines
                if (line === '') continue;
                
                // Skip all content when in Quick Tip section until next question
                if (inQuickTip) {
                    // If a subject header appears inside a Quick Tip, activate it immediately
                    const lt = line.toLowerCase();
                    if (lt.startsWith('## ')) {
                        const hdr = lt.replace('## ', '').trim();
                        if (hdr === 'mathematics' || hdr === 'physics' || hdr === 'chemistry') {
                            currentSubject = hdr;
                            pendingSubject = hdr;
                            debugContent += `<div style=\"color: #17a2b8; margin: 2px 0;\">Line ${i+1}: Subject header inside Quick Tip → set subject: ${currentSubject}</div>`;
                            // keep skipping until next question
                    continue;
                        }
                    }
                    const nextQuestionMatch = line.match(/^(\d+)\.\s*(.*)/);
                    if (nextQuestionMatch && !line.match(/^\d+\.\d/) && !/continued/i.test(nextQuestionMatch[2] || '')) {
                        inQuickTip = false;
                        debugContent += `<div style=\"color: #6c757d; margin: 2px 0;\">Line ${i+1}: Exiting Quick Tip section, found next question ${nextQuestionMatch[1]}</div>`;
                        // Continue processing this line as a new question
                    } else {
                        debugContent += `<div style=\"color: #6c757d; margin: 2px 0;\">Line ${i+1}: Skipping Quick Tip content: ${line.substring(0, 50)}...</div>`;
                        continue;
                    }
                }
                
                // Check for section breaks and subject activation pattern
                const lowerLine = line.toLowerCase();
                if (lowerLine.startsWith('## ')) {
                    const headerText = lowerLine.replace('## ', '').trim();
                    // Subject header encountered
                    if (headerText === 'mathematics' || headerText === 'physics' || headerText === 'chemistry') {
                        pendingSubject = headerText;
                        currentSubject = pendingSubject;
                        inSubjectSection = true;
                        console.log(`Line ${i+1}: Activated subject: ${currentSubject}`);
                        debugContent += `<div style=\"color: #007bff; margin: 2px 0;\">Line ${i+1}: Activated subject: ${currentSubject}</div>`;
                        continue;
                    }
                    // SECTION-A header encountered, activate subject if pending
                    if (/^section\s*-?\s*a\b/.test(headerText)) {
                        if (pendingSubject) {
                            currentSubject = pendingSubject;
                            inSubjectSection = true;
                            console.log(`Line ${i+1}: Activated subject section: ${currentSubject}`);
                            debugContent += `<div style=\"color: #17a2b8; margin: 2px 0;\">Line ${i+1}: Activated subject section: ${currentSubject}</div>`;
                            continue;
                        }
                    }
                }
                
                // Check for new question - number followed by dot
                let questionMatch = line.match(/^(\d+)\.\s*(.*)/);
                
                // Additional check: make sure it's not a decimal number
                if (questionMatch && line.match(/^\d+\.\d/)) {
                    debugContent += `<div style="color: #ffc107; margin: 2px 0;">Line ${i+1}: Ignored decimal number: ${line.substring(0, 50)}...</div>`;
                    questionMatch = null;
                }
                
                // Handle lines like "4. Continued." as part of previous solution, not a new question
                if (questionMatch && /continued/i.test(questionMatch[2] || '')) {
                    if (currentQuestion) {
                        // Treat as continuation of solution
                        inSolution = true;
                        currentQuestion.solution += '\n' + cleanImageReferences(line);
                        debugContent += `<div style="color: #ffc107; margin: 2px 0;">Line ${i+1}: Continued solution detected.</div>`;
                        continue;
                    }
                }
                
                if (questionMatch) {
                    // Save previous question if it exists
                    if (currentQuestion) {
                        questions.push(currentQuestion);
                    }
                    
                    // Start new question
                    currentQuestion = {
                        number: parseInt(questionMatch[1]),
                        text: cleanImageReferences(questionMatch[2]),
                        options: [],
                        answer: '',
                        solution: '',
                        subject: (inSubjectSection && currentSubject) ? currentSubject : 'unassigned',
                        type: 'mcq', // Default type, will be auto-detected
                        fullContent: cleanImageReferences(questionMatch[2])
                    };
                    inSolution = false;
                    inOptionCapture = false;
                    currentOptionNumber = 0;
                    inQuickTip = false;
                    
                    debugContent += `<div style="color: #28a745; margin: 2px 0; font-weight: bold;">Line ${i+1}: Found question ${currentQuestion.number}: ${questionMatch[2].substring(0, 100)}...</div>`;
                } else if (currentQuestion) {
                    // Check for "Correct Answer:" format
                    if (lowerLine.startsWith('correct answer')) {
                        // Accept both formats: (3) or 3
                        const caMatch = line.match(/Correct Answer:\s*(?:\(([1-4])\)|([1-4]))/i);
                        if (caMatch) {
                            currentQuestion.answer = (caMatch[1] || caMatch[2]);
                            debugContent += `<div style=\"color: #dc3545; margin: 2px 0;\">Line ${i+1}: Found correct answer: ${line}</div>`;
                        }
                        // Do not auto-enter solution mode yet; wait for explicit Solution header
                        // End option capture when correct answer encountered
                        inOptionCapture = false;
                        currentOptionNumber = 0;
                    }
                    // Check if we hit explicit Solution header
                    else if (lowerLine.startsWith('## solution') || /\\section\*\{\s*solution\s*:?\s*\}/i.test(line)) {
                        inSolution = true;
                        currentQuestion.solution = '';
                        debugContent += `<div style="color: #ffc107; margin: 2px 0;">Line ${i+1}: Started solution collection (Solution header).</div>`;
                    }
                    // Backward compatibility: older format had "Ans." then solution lines
                    else if (line.startsWith('Ans.')) {
                        // Extract answer - look for (1), (2), (3), (4) format
                        const answerMatch = line.match(/^Ans\.\s*\(([1-4])\)/);
                        if (answerMatch) {
                            currentQuestion.answer = answerMatch[1];
                            debugContent += `<div style="color: #dc3545; margin: 2px 0;">Line ${i+1}: Found answer: ${line}</div>`;
                        }
                        
                        // Start collecting solution
                        inSolution = true;
                        currentQuestion.solution = cleanImageReferences(line);
                        debugContent += `<div style="color: #ffc107; margin: 2px 0;">Line ${i+1}: Started solution collection: ${line.substring(0, 50)}...</div>`;
                    }
                    // Check for options (1), (2), (3), (4) - only if not in solution
                    else if (!inSolution) {
                        // Check if this is a fill-in-the-blank question (has $\_\_\_\_$)
                        const isFillInTheBlank = /\$\_\_\_\_\$/.test(currentQuestion.text + '\n' + line);
                        
                        // Support inline options: (1)...(2)...(3)...(4)... possibly across lines
                        // But don't treat "Correct Answer: (3)" as option markers
                        const hasAnyOptionMarker = /(\(1\)|\(2\)|\(3\)|\(4\))/.test(line) && !lowerLine.startsWith('correct answer');
                        
                        if ((hasAnyOptionMarker || inOptionCapture) && !isFillInTheBlank) {
                            // Initialize options array to fixed 4 slots on first encounter
                            if (!inOptionCapture) {
                                inOptionCapture = true;
                                currentOptionNumber = 0;
                                currentQuestion.options = ['', '', '', ''];
                            }
                            // Process markers in this line sequentially
                            let remaining = line;
                            // Helper to consume next marker and capture text until next marker or end
                            const markers = ['(1)', '(2)', '(3)', '(4)'];
                            while (remaining.length > 0) {
                                // Find next marker index among 1..4 that is >= currentOptionNumber+1
                                let nextIdx = -1;
                                let nextWhich = -1;
                                for (let m = 0; m < 4; m++) {
                                    const idx = remaining.indexOf(markers[m]);
                                    if (idx !== -1 && (nextIdx === -1 || idx < nextIdx)) {
                                        nextIdx = idx;
                                        nextWhich = m + 1; // option number
                                    }
                                }
                                if (nextIdx === -1) {
                                    // No marker in remaining; append to current option if we started
                                    if (currentOptionNumber >= 1 && currentOptionNumber <= 4) {
                                        currentQuestion.options[currentOptionNumber - 1] = (currentQuestion.options[currentOptionNumber - 1] + ' ' + cleanImageReferences(remaining)).trim();
                                    } else {
                                        // Before markers begin: treat as question text
                                        currentQuestion.text += '\n' + cleanImageReferences(remaining);
                                        currentQuestion.fullContent += '\n' + cleanImageReferences(remaining);
                                    }
                                    break;
                                }
                                // Content before next marker belongs to previous marker (if any)
                                const before = remaining.slice(0, nextIdx).trim();
                                if (before) {
                                    if (currentOptionNumber >= 1 && currentOptionNumber <= 4) {
                                        currentQuestion.options[currentOptionNumber - 1] = (currentQuestion.options[currentOptionNumber - 1] + ' ' + cleanImageReferences(before)).trim();
                                    } else {
                                        currentQuestion.text += '\n' + cleanImageReferences(before);
                                        currentQuestion.fullContent += '\n' + cleanImageReferences(before);
                                    }
                                }
                                // Advance past marker and set current option number
                                remaining = remaining.slice(nextIdx + markers[nextWhich - 1].length);
                                currentOptionNumber = nextWhich;
                                // Now, look ahead for the next marker in the updated remaining to capture text chunk for this option
                                let following = remaining;
                                let nextIdx2 = -1;
                                let nextWhich2 = -1;
                                for (let m2 = 0; m2 < 4; m2++) {
                                    const idx2 = following.indexOf(markers[m2]);
                                    if (idx2 !== -1 && (nextIdx2 === -1 || idx2 < nextIdx2)) {
                                        nextIdx2 = idx2;
                                        nextWhich2 = m2 + 1;
                                    }
                                }
                                let chunk;
                                if (nextIdx2 === -1) {
                                    chunk = following;
                                    remaining = '';
                                } else {
                                    chunk = following.slice(0, nextIdx2);
                                    remaining = following.slice(nextIdx2);
                                }
                                if (chunk && currentOptionNumber >= 1 && currentOptionNumber <= 4) {
                                    currentQuestion.options[currentOptionNumber - 1] = (currentQuestion.options[currentOptionNumber - 1] + ' ' + cleanImageReferences(chunk)).trim();
                                }
                            }
                        } else if (isFillInTheBlank) {
                            // For fill-in-the-blank questions, add all content to question text
                            currentQuestion.text += '\n' + cleanImageReferences(line);
                            currentQuestion.fullContent += '\n' + cleanImageReferences(line);
                            debugContent += `<div style="color: #17a2b8; margin: 2px 0;">Line ${i+1}: Fill-in-the-blank question content: ${line.substring(0, 50)}...</div>`;
                        } else {
                            // If not an option and not in solution, add to question text
                            currentQuestion.text += '\n' + cleanImageReferences(line);
                            currentQuestion.fullContent += '\n' + cleanImageReferences(line);
                        }
                    }
                    // If in solution, continue collecting until next question
                    else if (inSolution) {
                        // Stop solution at Quick Tip headers (both markdown and LaTeX formats)
                        if (lowerLine.startsWith('## quick tip') || /\\section\*\{\s*quick\s+tip\s*:?\s*\}/i.test(line)) {
                            inSolution = false;
                            inQuickTip = true;
                            debugContent += `<div style=\"color: #6c757d; margin: 2px 0;\">Line ${i+1}: Quick Tip header - ending solution collection and starting tip skip.</div>`;
                            continue;
                        }
                        // Check if this is the start of a new question
                        const nextQuestionMatch = line.match(/^(\d+)\.\s*(.*)/);
                        if (nextQuestionMatch && !line.match(/^\d+\.\d/) && !/continued/i.test(nextQuestionMatch[2] || '')) {
                            // This is a new question, stop collecting solution and process current question
                            inSolution = false;
                            
                            
                            
                            
                            // Save current question and start new one
                            questions.push(currentQuestion);
                            
                            // Start new question
                            currentQuestion = {
                                number: parseInt(nextQuestionMatch[1]),
                                text: cleanImageReferences(nextQuestionMatch[2]),
                                options: [],
                                answer: '',
                                solution: '',
                                subject: (inSubjectSection && currentSubject) ? currentSubject : 'unassigned',
                                type: 'mcq', // Default type, will be auto-detected
                                fullContent: cleanImageReferences(nextQuestionMatch[2])
                            };
                            
                            debugContent += `<div style="color: #28a745; margin: 2px 0; font-weight: bold;">Line ${i+1}: Found question ${currentQuestion.number}: ${nextQuestionMatch[2].substring(0, 100)}...</div>`;
                        } else {
                            // Continue collecting solution
                            currentQuestion.solution += '\n' + cleanImageReferences(line);
                            debugContent += `<div style="color: #ffc107; margin: 2px 0;">Line ${i+1}: Solution line: ${line.substring(0, 50)}...</div>`;
                        }
                    }
                }
            }
            
            // Ensure the last question is captured even if solution ended with a Quick Tip or EOF
            if (currentQuestion) {
                questions.push(currentQuestion);
            }
            
            // Show debug info
            debugContent += `<div style="color: #007bff; font-weight: bold; margin: 10px 0; font-size: 16px;">Total questions found: ${questions.length}</div>`;
            debugContent += `<div style="color: #28a745; font-weight: bold; margin: 5px 0;">Question numbers: ${questions.map(q => q.number).join(', ')}</div>`;
            
            // Show which question numbers are found (preserving original numbers from .md)
            const questionNumbers = questions.map(q => parseInt(q.number)).sort((a, b) => a - b);
            
            debugContent += `<div style="color: #6c757d; margin: 5px 0;">Found question numbers: ${questionNumbers.join(', ')}</div>`;
            debugContent += `<div style="color: #6c757d; margin: 5px 0;">Total questions parsed: ${questions.length}</div>`;
            
            // Group by subject for better overview
            const bySubject = {};
            questions.forEach(q => {
                if (!bySubject[q.subject]) bySubject[q.subject] = [];
                bySubject[q.subject].push(q.number);
            });
            
            Object.keys(bySubject).forEach(subject => {
                const subjectQuestions = bySubject[subject].sort((a, b) => a - b);
                debugContent += `<div style="color: #17a2b8; margin: 5px 0;">${subject}: Q${subjectQuestions.join(', Q')}</div>`;
            });
            
            // Debug info removed - console logging only
            console.log('Debug info:', debugContent);
            
            console.log(`Found ${questions.length} questions`);
            console.log('Question numbers:', questions.map(q => q.number).join(', '));
            allQuestions = questions;
            
            // Auto-detect question types for all questions
            allQuestions.forEach(question => {
                const detectedType = detectQuestionType(question);
                question.type = detectedType;
            });
            
            displayQuestions();
            updateStats();
            
            // Populate question lists for all subjects
            populateQuestionList('Mathematics');
            populateQuestionList('Physics');
            populateQuestionList('Chemistry');
        }
        
        function extractImagesFromText(text) {
            if (!text) return [];
            const imageMatches = text.match(/!\[\]\([^)]+\)/g);
            if (!imageMatches) return [];
            return imageMatches.map(match => {
                const urlMatch = match.match(/!\[\]\(([^)]+)\)/);
                return urlMatch ? urlMatch[1] : null;
            }).filter(url => url !== null);
        }
        
        function extractImagesFromOriginalText(text) {
            if (!text) return [];
            // Look for both markdown and HTML image formats
            const markdownImages = text.match(/!\[\]\([^)]+\)/g);
            const htmlImages = text.match(/<img[^>]+src="([^"]+)"[^>]*>/g);
            
            let images = [];
            if (markdownImages) {
                images = images.concat(markdownImages.map(match => {
                    const urlMatch = match.match(/!\[\]\(([^)]+)\)/);
                    return urlMatch ? urlMatch[1] : null;
                }).filter(url => url !== null));
            }
            if (htmlImages) {
                images = images.concat(htmlImages.map(match => {
                    const urlMatch = match.match(/src="([^"]+)"/);
                    return urlMatch ? urlMatch[1] : null;
                }).filter(url => url !== null));
            }
            return images;
        }
        
        function extractImagesFromHTML(text) {
            if (!text) return [];
            const imageMatches = text.match(/<img[^>]+src="([^"]+)"[^>]*>/g);
            if (!imageMatches) return [];
            return imageMatches.map(match => {
                const urlMatch = match.match(/src="([^"]+)"/);
                return urlMatch ? urlMatch[1] : null;
            }).filter(url => url !== null);
        }
        
        function extractAllImages(text) {
            if (!text) return [];
            const markdownImages = extractImagesFromText(text);
            const htmlImages = extractImagesFromHTML(text);
            return [...markdownImages, ...htmlImages];
        }
        
        function extractOptionsFromText(text) {
            if (!text) return [];
            const optionMatches = text.match(/\([1-4]\)\s*[^\n]+/g);
            if (!optionMatches) return [];
            return optionMatches.map(match => match.trim());
        }
        
        function cleanQuestionText(text) {
            // Remove options from question text
            return text.replace(/\([1-4]\)\s*[^\n]+/g, '').trim();
        }
        
        function cleanSolutionText(text) {
            // Remove markdown images from solution text
            let cleaned = text.replace(/!\[\]\([^)]+\)/g, '').trim();
            
            // Remove "Ans. (X)\nSol." prefix since it's already in correctAnswer and correctAnswerText
            cleaned = cleaned.replace(/^Ans\.\s*\([1-4]\)\s*\n?Sol\.\s*\n?/i, '').trim();
            
            return cleaned;
        }
        
        function displayQuestions() {
            const container = document.getElementById('questionsList');
            container.innerHTML = '';
            
            // Ensure all questions have options and answers extracted
            allQuestions.forEach(question => {
                if (question.options.length === 0) {
                    // Extract options from question text as fallback
                    const optionMatches = question.text.match(/\([1-4]\)\s*[^\n]+/g);
                    if (optionMatches) {
                        question.options = optionMatches;
                        // Remove options from question text
                        question.text = question.text.replace(/\([1-4]\)\s*[^\n]+/g, '').trim();
                    }
                }
                
                // Extract answer from solution if not already parsed
                if (!question.answer && question.solution) {
                    const answerMatch = question.solution.match(/Ans\.\s*\(([1-4])\)/);
                    if (answerMatch) {
                        question.answer = answerMatch[1];
                    }
                }
            });
            
            // Generate JSON structure in the required format
            const jsonStructure = [
                {
                    "tutorialId": "JEE_2025_Mathematics",
                    "tutorialTitle": "JEE 2025 Mathematics",
                    "tutorialDescription": "JEE 2025 Mathematics Questions with Solutions",
                    "authorityExamId": "jee_2025",
                    "state": "All India",
                    "board": "JEE",
                    "conductedBy": "NTA (National Testing Agency)",
                    "year": "2025",
                    "subject": "Mathematics",
                    "questions": allQuestions
                        .filter(q => q.subject === 'Mathematics' || q.subject === 'mathematics')
                        .map(question => ({
                            "questionIndex": question.number.toString(),
                            "questionId": `2025MQ${question.number}`,
                            "questionDetails": [
                                {
                                    "text": cleanQuestionText(question.text),
                                    "textImages": extractImagesFromOriginalText(question.text),
                                    "possibleAnswers": {
                                        "A": {
                                            "text": question.options[0]?.replace(/^\(1\)\s*/, '').trim() || "",
                                            "image": extractImagesFromOriginalText(question.options[0] || "")
                                        },
                                        "B": {
                                            "text": question.options[1]?.replace(/^\(2\)\s*/, '').trim() || "",
                                            "image": extractImagesFromOriginalText(question.options[1] || "")
                                        },
                                        "C": {
                                            "text": question.options[2]?.replace(/^\(3\)\s*/, '').trim() || "",
                                            "image": extractImagesFromOriginalText(question.options[2] || "")
                                        },
                                        "D": {
                                            "text": question.options[3]?.replace(/^\(4\)\s*/, '').trim() || "",
                                            "image": extractImagesFromOriginalText(question.options[3] || "")
                                        }
                                    },
                                    "correctAnswer": question.answer,
                                    "correctAnswerText": question.options[parseInt(question.answer) - 1]?.replace(/^\(\d+\)\s*/, '').trim() || "",
                                    "solution": cleanSolutionText(question.solution),
                                    "solutionImages": extractImagesFromOriginalText(question.solution)
                                }
                            ]
                        }))
                },
                {
                    "tutorialId": "JEE_2025_Physics",
                    "tutorialTitle": "JEE 2025 Physics",
                    "tutorialDescription": "JEE 2025 Physics Questions with Solutions",
                    "authorityExamId": "jee_2025",
                    "state": "All India",
                    "board": "JEE",
                    "conductedBy": "NTA (National Testing Agency)",
                    "year": "2025",
                    "subject": "Physics",
                    "questions": allQuestions
                        .filter(q => q.subject === 'Physics' || q.subject === 'physics')
                        .map(question => ({
                            "questionIndex": question.number.toString(),
                            "questionId": `2025PQ${question.number}`,
                            "questionDetails": [
                                {
                                    "text": cleanQuestionText(question.text),
                                    "textImages": extractImagesFromOriginalText(question.text),
                                    "possibleAnswers": {
                                        "A": {
                                            "text": question.options[0]?.replace(/^\(1\)\s*/, '').trim() || "",
                                            "image": extractImagesFromOriginalText(question.options[0] || "")
                                        },
                                        "B": {
                                            "text": question.options[1]?.replace(/^\(2\)\s*/, '').trim() || "",
                                            "image": extractImagesFromOriginalText(question.options[1] || "")
                                        },
                                        "C": {
                                            "text": question.options[2]?.replace(/^\(3\)\s*/, '').trim() || "",
                                            "image": extractImagesFromOriginalText(question.options[2] || "")
                                        },
                                        "D": {
                                            "text": question.options[3]?.replace(/^\(4\)\s*/, '').trim() || "",
                                            "image": extractImagesFromOriginalText(question.options[3] || "")
                                        }
                                    },
                                    "correctAnswer": question.answer,
                                    "correctAnswerText": question.options[parseInt(question.answer) - 1]?.replace(/^\(\d+\)\s*/, '').trim() || "",
                                    "solution": cleanSolutionText(question.solution),
                                    "solutionImages": extractImagesFromOriginalText(question.solution)
                                }
                            ]
                        }))
                },
                {
                    "tutorialId": "JEE_2025_Chemistry",
                    "tutorialTitle": "JEE 2025 Chemistry",
                    "tutorialDescription": "JEE 2025 Chemistry Questions with Solutions",
                    "authorityExamId": "jee_2025",
                    "state": "All India",
                    "board": "JEE",
                    "conductedBy": "NTA (National Testing Agency)",
                    "year": "2025",
                    "subject": "Chemistry",
                    "questions": allQuestions
                        .filter(q => q.subject === 'Chemistry' || q.subject === 'chemistry')
                        .map(question => ({
                            "questionIndex": question.number.toString(),
                            "questionId": `2025CQ${question.number}`,
                            "questionDetails": [
                                {
                                    "text": cleanQuestionText(question.text),
                                    "textImages": extractImagesFromOriginalText(question.text),
                                    "possibleAnswers": {
                                        "A": {
                                            "text": question.options[0]?.replace(/^\(1\)\s*/, '').trim() || "",
                                            "image": extractImagesFromOriginalText(question.options[0] || "")
                                        },
                                        "B": {
                                            "text": question.options[1]?.replace(/^\(2\)\s*/, '').trim() || "",
                                            "image": extractImagesFromOriginalText(question.options[1] || "")
                                        },
                                        "C": {
                                            "text": question.options[2]?.replace(/^\(3\)\s*/, '').trim() || "",
                                            "image": extractImagesFromOriginalText(question.options[2] || "")
                                        },
                                        "D": {
                                            "text": question.options[3]?.replace(/^\(4\)\s*/, '').trim() || "",
                                            "image": extractImagesFromOriginalText(question.options[3] || "")
                                        }
                                    },
                                    "correctAnswer": question.answer,
                                    "correctAnswerText": question.options[parseInt(question.answer) - 1]?.replace(/^\(\d+\)\s*/, '').trim() || "",
                                    "solution": cleanSolutionText(question.solution),
                                    "solutionImages": extractImagesFromOriginalText(question.solution)
                                }
                            ]
                        }))
                }
            ];
            
            // Display JSON structure in left panel
            const jsonDisplay = document.createElement('div');
            jsonDisplay.className = 'json-display';
            jsonDisplay.innerHTML = `
                <h4>📊 Question Data Structure</h4>
                <pre><code>${JSON.stringify(jsonStructure, null, 2)}</code></pre>
            `;
            container.appendChild(jsonDisplay);
            
            // Also create individual question cards for interaction
            allQuestions.forEach((question, index) => {
                const questionCard = document.createElement('div');
                questionCard.className = 'question-card';
                questionCard.onclick = () => scrollToQuestion(question.number, 'all');
                
                const optionsHtml = question.options.map(opt => 
                    `<div class="option">(${opt.number}) ${opt.text}</div>`
                ).join('\n');
                
                // Set the selected value based on the detected subject
                const selectedSubject = question.subject === 'unassigned' ? '' : question.subject.charAt(0).toUpperCase() + question.subject.slice(1);
                
                questionCard.innerHTML = `
                    <div class="question-header">
                        <div class="question-number">Q${question.number}</div>
                        <select class="subject-selector" onchange="assignSubject(${index}, this.value); event.stopPropagation();">
                            <option value="">Select Subject</option>
                            <option value="Mathematics" ${selectedSubject === 'Mathematics' ? 'selected' : ''}>Mathematics</option>
                            <option value="Physics" ${selectedSubject === 'Physics' ? 'selected' : ''}>Physics</option>
                            <option value="Chemistry" ${selectedSubject === 'Chemistry' ? 'selected' : ''}>Chemistry</option>
                        </select>
                    </div>
                    <div class="question-text">${question.text}</div>
                    <div class="question-options">${optionsHtml}</div>
                    ${question.answer ? `<div class="answer">Answer: (${question.answer})</div>` : ''}
                    ${question.solution ? `<div class="solution">Solution: ${cleanSolutionText(question.solution)}</div>` : ''}
                    ${question.subject !== 'unassigned' ? `<div class="answer" style="color: #4facfe;">Detected Subject: ${selectedSubject}</div>` : ''}
                `;
                
                container.appendChild(questionCard);
            });
            
            // Render all questions in the right panel
            // Show Mathematics tab by default
            showSubject('Mathematics');
            
            // Populate edit interfaces for all subjects
            populateInlineEditFields('Mathematics');
            populateInlineEditFields('Physics');
            populateInlineEditFields('Chemistry');
            
            document.getElementById('sidebarSubjectTabs').style.display = 'block';
        }
        
        function assignSubject(questionIndex, subject) {
            const question = allQuestions[questionIndex];
            questionAssignments[question.number] = subject;
            updateStats();
            updateAssignmentsDisplay();
        }
        
        function updateStats() {
            const total = allQuestions.length;
            
            // Count questions by subject (assigned or detected)
            const math = allQuestions.filter(q => {
                const assignedSubject = questionAssignments[q.number];
                const detectedSubject = q.subject;
                return assignedSubject === 'Mathematics' || 
                       (detectedSubject === 'mathematics' && !assignedSubject) ||
                       (detectedSubject === 'mathematics');
            }).length;
            
            const physics = allQuestions.filter(q => {
                const assignedSubject = questionAssignments[q.number];
                const detectedSubject = q.subject;
                return assignedSubject === 'Physics' || 
                       (detectedSubject === 'physics' && !assignedSubject) ||
                       (detectedSubject === 'physics');
            }).length;
            
            const chemistry = allQuestions.filter(q => {
                const assignedSubject = questionAssignments[q.number];
                const detectedSubject = q.subject;
                return assignedSubject === 'Chemistry' || 
                       (detectedSubject === 'chemistry' && !assignedSubject) ||
                       (detectedSubject === 'chemistry');
            }).length;
            
            // Update sidebar statistics
            document.getElementById('sidebar-total-questions').textContent = total;
            document.getElementById('sidebar-count-Mathematics').textContent = math;
            document.getElementById('sidebar-count-Physics').textContent = physics;
            document.getElementById('sidebar-count-Chemistry').textContent = chemistry;
            
            // Calculate extracted questions (questions that have been assigned or detected)
            const extracted = math + physics + chemistry;
            document.getElementById('sidebar-extracted-questions').textContent = extracted;
            
            // Show sidebar stats and download section
            document.getElementById('sidebarStats').style.display = 'block';
            document.getElementById('sidebarDownload').style.display = 'block';
        }
        
        function updateAssignmentsDisplay() {
            // Assignment display removed - console logging only
            const subjects = ['Mathematics', 'Physics', 'Chemistry'];
            
            subjects.forEach(subject => {
                const questions = Object.entries(questionAssignments)
                    .filter(([num, sub]) => sub === subject)
                    .map(([num]) => num)
                    .sort((a, b) => parseInt(a) - parseInt(b));
                
                console.log(`${subject}: ${questions.length} questions - ${questions.join(', ')}`);
            });
        }
        
        function generateJSON() {
            const subjects = ['Mathematics', 'Physics', 'Chemistry'];
            const result = {};
            
            subjects.forEach(subject => {
                const subjectQuestions = allQuestions
                    .filter(q => questionAssignments[q.number] === subject)
                    .map((q, index) => ({
                        questionIndex: q.number.toString(),
                        questionId: `Q${q.number}`,
                        questionDetails: [{
                            text: q.text,
                            textImages: [],
                            possibleAnswers: q.options.reduce((acc, opt) => {
                                const letter = String.fromCharCode(64 + parseInt(opt.number));
                                acc[letter] = { text: opt.text, image: null };
                                return acc;
                            }, {}),
                            correctAnswer: String.fromCharCode(64 + parseInt(q.answer)),
                            correctAnswerText: q.options.find(opt => opt.number === q.answer)?.text || ''
                        }],
                        subject: subject,
                        solution: q.solution,
                        marks: '4'
                    }));
                
                result[subject] = {
                    subject: subject,
                    totalQuestions: subjectQuestions.length,
                    questions: subjectQuestions
                };
            });
            
            console.log('Generated JSON:', result);
            
            // Show JSON in a new window
            const jsonWindow = window.open('', '_blank');
            jsonWindow.document.write(`
                <html>
                <head><title>Generated JSON</title></head>
                <body>
                    <h1>Generated JSON Output</h1>
                    <pre style="background: #f5f5f5; padding: 20px; border-radius: 5px; overflow-x: auto;">${JSON.stringify(result, null, 2)}</pre>
                </body>
                </html>
            `);
        }
        
        function downloadAssignments() {
            const data = {
                assignments: questionAssignments,
                questions: allQuestions.map(q => ({
                    number: q.number,
                    text: q.text,
                    subject: questionAssignments[q.number] || 'Unassigned'
                }))
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'question_assignments.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
        
        function resetAssignments() {
            questionAssignments = {};
            document.querySelectorAll('.subject-selector').forEach(select => {
                select.value = '';
            });
            updateStats();
            updateAssignmentsDisplay();
        }
        
        function showSubject(subject) {
            console.log(`Switching to subject: ${subject}`);
            
            // Update sidebar tab buttons
            document.querySelectorAll('.subject-tab-sidebar').forEach(btn => {
                btn.classList.remove('active');
            });
            document.getElementById(`sidebar-tab-${subject}`).classList.add('active');
            
            // Hide all subject views
            document.querySelectorAll('.subject-view').forEach(view => {
                view.style.display = 'none';
                view.classList.remove('active');
            });
            
            // Show subject split view
            document.getElementById('questionsContainer').style.display = 'none';
            
            const subjectViewElement = document.getElementById(`subjectView-${subject}`);
            console.log(`Looking for element: subjectView-${subject}`);
            console.log(`Element found:`, subjectViewElement);
            
            if (subjectViewElement) {
                subjectViewElement.style.display = 'block';
                subjectViewElement.classList.add('active');
                console.log(`Activated subject view for ${subject}`);
                
                // Populate the question list for the selected subject (if not already populated)
                const questionListContainer = document.getElementById(`questionList-${subject}`);
                if (questionListContainer && questionListContainer.children.length <= 1) {
                    populateQuestionList(subject);
                }
                
                // Generate and display questions for this subject
                generateSubjectView(subject);
                
                // Generate the full Live Preview with all questions for this subject
                generateQuestionRender(subject, 0); // Start with question 0
            } else {
                console.error(`Element subjectView-${subject} not found!`);
            }
        }
        
        function renderAllQuestions(context) {
            const renderElement = document.getElementById(context === 'all' ? 'allQuestionsRender' : 
                                                      context === 'Mathematics' ? 'mathRender' :
                                                      context === 'Physics' ? 'physicsRender' : 'chemistryRender');
            
            if (!renderElement) return;
            
            // Get questions to render
            let questionsToRender = allQuestions;
            if (context !== 'all') {
                questionsToRender = allQuestions.filter(q => {
                    const assignedSubject = questionAssignments[q.number];
                    const detectedSubject = q.subject;
                    return assignedSubject === context || 
                           (detectedSubject && detectedSubject.toLowerCase() === context.toLowerCase());
                });
            }
            
            let renderHtml = '';
            questionsToRender.forEach((question, index) => {
                // Extract options from question.options array
                const optionsHtml = question.options.map((opt, optIndex) => {
                    const letter = String.fromCharCode(65 + optIndex); // A, B, C, D
                    const cleanText = opt.replace(/^\(\d+\)\s*/, '').trim();
                    return `<div class="option-render"><strong>${letter}.</strong> ${cleanText}</div>`;
                }).join('\n');
                
                // Find correct answer text
                const answerIndex = parseInt(question.answer) - 1;
                const answerText = question.options[answerIndex]?.replace(/^\(\d+\)\s*/, '').trim() || '';
                const answerLetter = question.answer ? String.fromCharCode(64 + parseInt(question.answer)) : '';
                
                renderHtml += `
                    <div class="question-render" id="render-q${question.number}">
                        <h4>Question ${question.number}</h4>
                        <div class="question-text">${question.text}</div>
                        <div class="options-render">${optionsHtml}</div>
                        ${answerText ? `<div class="answer-render">Answer: ${answerLetter}. ${answerText}</div>` : ''}
                        ${question.solution ? `<div class="solution-render">Solution: ${cleanSolutionText(question.solution)}</div>` : ''}
                        <hr style="margin: 20px 0; border: 1px solid #eee;">
                    </div>
                `;
            });
            
            renderElement.innerHTML = renderHtml;
            
            // Re-render MathJax
            if (window.MathJax) {
                MathJax.typesetPromise([renderElement]).catch((err) => console.log('MathJax error:', err));
            }
        }
        
        function scrollToQuestion(questionNumber, context) {
            const renderElement = document.getElementById(context === 'all' ? 'allQuestionsRender' : 
                                                      context === 'Mathematics' ? 'mathRender' :
                                                      context === 'Physics' ? 'physicsRender' : 'chemistryRender');
            
            if (!renderElement) return;
            
            const targetElement = document.getElementById(`render-q${questionNumber}`);
            if (targetElement) {
                // Scroll the target question into view
                targetElement.scrollIntoView({ 
                    behavior: 'smooth', 
                    block: 'start',
                    inline: 'nearest'
                });
                
                // Add a highlight effect
                targetElement.style.backgroundColor = '#fff3cd';
                targetElement.style.border = '2px solid #ffc107';
                targetElement.style.borderRadius = '8px';
                targetElement.style.transition = 'all 0.3s ease';
                
                // Remove highlight after 2 seconds
                setTimeout(() => {
                    targetElement.style.backgroundColor = '';
                    targetElement.style.border = '';
                }, 2000);
            }
        }
        
        function generateSubjectView(subject) {
            // Get questions for this subject
            const subjectQuestions = allQuestions.filter(q => {
                const assignedSubject = questionAssignments[q.number];
                const detectedSubject = q.subject;
                
                return assignedSubject === subject || 
                       (detectedSubject && detectedSubject.toLowerCase() === subject.toLowerCase());
            });
            
            console.log(`Generating view for ${subject}: ${subjectQuestions.length} questions`);
            
            // Get the questions list container for this subject
            const questionsListId = subject === 'Mathematics' ? 'mathQuestionsList' :
                                   subject === 'Physics' ? 'physicsQuestionsList' : 'chemistryQuestionsList';
            const container = document.getElementById(questionsListId);
            
            if (!container) {
                console.error(`Container ${questionsListId} not found!`);
                return;
            }
            
            container.innerHTML = '';
            
            if (subjectQuestions.length === 0) {
                container.innerHTML = `<p>No questions found for ${subject}.</p>`;
                return;
            }
            
            // Create question cards for this subject
            subjectQuestions.forEach((question, index) => {
                const questionCard = document.createElement('div');
                questionCard.className = 'question-card';
                questionCard.onclick = () => scrollToQuestion(question.number, subject);
                
                const optionsHtml = question.options.map((opt, optIndex) => {
                    const letter = String.fromCharCode(65 + optIndex); // A, B, C, D
                    const cleanText = opt.replace(/^\(\d+\)\s*/, '').trim();
                    return `<div class="option">
                        <strong>${letter}.</strong> 
                        <input type="text" class="option-input" value="${cleanText}" 
                               data-question="${question.number}" data-option="${optIndex}"
                               onclick="event.stopPropagation()" 
                               onchange="updateQuestionOption(${question.number}, ${optIndex}, this.value, '${subject}')">
                    </div>`;
                }).join('\n');
                
                questionCard.innerHTML = `
                    <div class="question-header">
                        <div class="question-number">Q${question.number}</div>
                        <div class="question-actions">
                            <button class="edit-btn" onclick="event.stopPropagation(); toggleQuestionEdit(${question.number}, '${subject}')">✏️ Edit</button>
                        </div>
                    </div>
                    <div class="question-content">
                        <div class="question-text">
                            <textarea class="question-textarea" data-question="${question.number}" 
                                      onclick="event.stopPropagation()" 
                                      onchange="updateQuestionText(${question.number}, this.value, '${subject}')">${question.text}</textarea>
                        </div>
                        <div class="question-options">${optionsHtml}</div>
                        <div class="answer-section">
                            <label>Correct Answer:</label>
                            <select class="answer-select" data-question="${question.number}" 
                                    onclick="event.stopPropagation()" 
                                    onchange="updateQuestionAnswer(${question.number}, this.value, '${subject}')">
                                <option value="1" ${question.answer === '1' ? 'selected' : ''}>A</option>
                                <option value="2" ${question.answer === '2' ? 'selected' : ''}>B</option>
                                <option value="3" ${question.answer === '3' ? 'selected' : ''}>C</option>
                                <option value="4" ${question.answer === '4' ? 'selected' : ''}>D</option>
                            </select>
                        </div>
                        <div class="solution-section">
                            <label>Solution:</label>
                            <textarea class="solution-textarea" data-question="${question.number}" 
                                      onclick="event.stopPropagation()" 
                                      onchange="updateQuestionSolution(${question.number}, this.value, '${subject}')">${question.solution || ''}</textarea>
                        </div>
                    </div>
                `;
                
                container.appendChild(questionCard);
            });
            
            // Display JSON in the right panel
            displaySubjectJSON(subject);
            
            // Render all questions in the right panel
            renderAllQuestions(subject);
        }
        
        function displaySubjectJSON(subject) {
            // Get questions for this subject
            const subjectQuestions = allQuestions.filter(q => {
                const assignedSubject = questionAssignments[q.number];
                const detectedSubject = q.subject;
                return assignedSubject === subject || 
                       (detectedSubject && detectedSubject.toLowerCase() === subject.toLowerCase());
            });
            
            if (subjectQuestions.length === 0) {
                return;
            }
            
            // Get values from form inputs
            const getFormValue = (fieldId) => {
                const element = document.getElementById(fieldId);
                return element ? element.value : '';
            };
            
            const tutorialId = getFormValue(`tutorialId${subject === 'Mathematics' ? '' : subject === 'Physics' ? '-physics' : '-chemistry'}`);
            const tutorialTitle = getFormValue(`tutorialTitle${subject === 'Mathematics' ? '' : subject === 'Physics' ? '-physics' : '-chemistry'}`);
            const tutorialDescription = getFormValue(`tutorialDescription${subject === 'Mathematics' ? '' : subject === 'Physics' ? '-physics' : '-chemistry'}`);
            const authorityExamId = getFormValue(`authorityExamId${subject === 'Mathematics' ? '' : subject === 'Physics' ? '-physics' : '-chemistry'}`);
            const state = getFormValue(`state${subject === 'Mathematics' ? '' : subject === 'Physics' ? '-physics' : '-chemistry'}`);
            const board = getFormValue(`board${subject === 'Mathematics' ? '' : subject === 'Physics' ? '-physics' : '-chemistry'}`);
            const conductedBy = getFormValue(`conductedBy${subject === 'Mathematics' ? '' : subject === 'Physics' ? '-physics' : '-chemistry'}`);
            const year = getFormValue(`year${subject === 'Mathematics' ? '' : subject === 'Physics' ? '-physics' : '-chemistry'}`);
            const subjectValue = getFormValue(`subject${subject === 'Mathematics' ? '' : subject === 'Physics' ? '-physics' : '-chemistry'}`);
            
            // Generate JSON structure
            const jsonData = [{
                "tutorialId": tutorialId || `JEE_2025_${subject}`,
                "tutorialTitle": tutorialTitle || `JEE 2025 ${subject}`,
                "tutorialDescription": tutorialDescription || `JEE 2025 ${subject} Questions with Solutions`,
                "authorityExamId": authorityExamId || "jee_2025",
                "state": state || "All India",
                "board": board || "JEE",
                "conductedBy": conductedBy || "NTA (National Testing Agency)",
                "year": year || "2025",
                "subject": subjectValue || subject,
                "questions": subjectQuestions.map(question => ({
                    "questionIndex": question.number.toString(),
                    "questionId": `2025${subject.charAt(0)}Q${question.number}`,
                    "questionDetails": [{
                        "text": cleanQuestionText(question.text),
                        "textImages": extractImagesFromOriginalText(question.text),
                        "possibleAnswers": {
                            "A": {
                                "text": question.options[0]?.replace(/^\(1\)\s*/, '').trim() || "",
                                "image": extractImagesFromOriginalText(question.options[0] || "")
                            },
                            "B": {
                                "text": question.options[1]?.replace(/^\(2\)\s*/, '').trim() || "",
                                "image": extractImagesFromOriginalText(question.options[1] || "")
                            },
                            "C": {
                                "text": question.options[2]?.replace(/^\(3\)\s*/, '').trim() || "",
                                "image": extractImagesFromOriginalText(question.options[2] || "")
                            },
                            "D": {
                                "text": question.options[3]?.replace(/^\(4\)\s*/, '').trim() || "",
                                "image": extractImagesFromOriginalText(question.options[3] || "")
                            }
                        },
                        "correctAnswer": question.answer,
                        "correctAnswerText": question.options[parseInt(question.answer) - 1]?.replace(/^\(\d+\)\s*/, '').trim() || "",
                        "solution": cleanSolutionText(question.solution),
                        "solutionImages": extractImagesFromOriginalText(question.solution)
                    }]
                }))
            }];
            
            // Display JSON in the right panel
            const jsonContainerId = subject === 'Mathematics' ? 'mathQuestionsList' :
                                   subject === 'Physics' ? 'physicsQuestionsList' : 'chemistryQuestionsList';
            const jsonContainer = document.getElementById(jsonContainerId);
            if (jsonContainer) {
                jsonContainer.innerHTML = `
                    <div class="json-container">
                        <div class="json-display">
                            <h4>Question Data Structure</h4>
                            <pre><code>${JSON.stringify(jsonData, null, 2)}</code></pre>
                        </div>
                    </div>
                `;
            }
            
            // Add event listeners to form inputs to update JSON in real-time
            const suffix = subject === 'Mathematics' ? '' : subject === 'Physics' ? '-physics' : '-chemistry';
            const formInputs = [
                `tutorialId${suffix}`, `tutorialTitle${suffix}`, `tutorialDescription${suffix}`,
                `authorityExamId${suffix}`, `state${suffix}`, `board${suffix}`,
                `conductedBy${suffix}`, `year${suffix}`, `subject${suffix}`
            ];
            
            formInputs.forEach(inputId => {
                const input = document.getElementById(inputId);
                if (input) {
                    input.addEventListener('input', () => {
                        // Regenerate JSON with updated values
                        displaySubjectJSON(subject);
                    });
                }
            });
        }
        
        // Question editing functions
        function updateQuestionText(questionNumber, newText, subject) {
            const question = allQuestions.find(q => q.number === questionNumber);
            if (question) {
                question.text = newText;
                // Update the render view
                renderAllQuestions(subject);
                // Update JSON
                displaySubjectJSON(subject);
            }
        }
        
        function updateQuestionOption(questionNumber, optionIndex, newText, subject) {
            const question = allQuestions.find(q => q.number === questionNumber);
            if (question && question.options[optionIndex]) {
                // Update the option text while preserving the numbering
                const optionNumber = optionIndex + 1;
                question.options[optionIndex] = `(${optionNumber}) ${newText}`;
                // Update the render view
                renderAllQuestions(subject);
                // Update JSON
                displaySubjectJSON(subject);
            }
        }
        
        function updateQuestionAnswer(questionNumber, newAnswer, subject) {
            const question = allQuestions.find(q => q.number === questionNumber);
            if (question) {
                question.answer = newAnswer;
                // Update the render view
                renderAllQuestions(subject);
                // Update JSON
                displaySubjectJSON(subject);
            }
        }
        
        function updateQuestionSolution(questionNumber, newSolution, subject) {
            const question = allQuestions.find(q => q.number === questionNumber);
            if (question) {
                question.solution = newSolution;
                // Update the render view
                renderAllQuestions(subject);
                // Update JSON
                displaySubjectJSON(subject);
            }
        }
        
        function updateQuestion(questionId, field, value, optionIndex = null) {
            console.log('updateQuestion called:', { questionId, field, value, optionIndex });
            const question = allQuestions.find(q => q.number === questionId);
            if (!question) {
                console.log('Question not found with number:', questionId);
                console.log('Available questions:', allQuestions.map(q => q.number));
                return;
            }
            
            console.log('Found question:', question);
            
            if (field === 'text') {
                question.text = value;
                console.log('Updated text to:', value);
                // Auto-detect question type when text changes
                updateQuestionType(questionId);
            } else if (field === 'option' && optionIndex !== null) {
                // Ensure options array exists
                if (!question.options) {
                    question.options = ['', '', '', ''];
                }
                // Update option text while preserving the numbering
                const optionNumber = optionIndex + 1;
                question.options[optionIndex] = `(${optionNumber}) ${value}`;
                console.log(`Updated option ${optionIndex} to:`, question.options[optionIndex]);
                // Auto-detect question type when options change
                updateQuestionType(questionId);
            } else if (field === 'solution') {
                question.solution = value;
                console.log('Updated solution to:', value);
            } else if (field === 'answer') {
                question.answer = value;
                console.log('Updated answer to:', value);
            } else if (field === 'type') {
                question.type = value;
                console.log('Updated type to:', value);
            }
            
            // Update the Live Preview immediately
            console.log('Calling updateLivePreview...');
            updateLivePreview();
        }
        
        function updateLivePreview() {
            console.log('updateLivePreview called');
            const currentSubject = getCurrentSubject();
            const currentQuestionIndex = getCurrentQuestionIndex();
            
            console.log('Current subject:', currentSubject);
            console.log('Current question index:', currentQuestionIndex);
            
            if (currentSubject && currentQuestionIndex !== null) {
                console.log('Calling generateQuestionRender...');
                generateQuestionRender(currentSubject, currentQuestionIndex);
                
                // Also update JSON content if JSON viewer is active
                const jsonPanel = document.getElementById(`jsonViewer-${currentSubject}`);
                if (jsonPanel && jsonPanel.style.display === 'flex') {
                    generateJSONContent(currentSubject);
                }
            } else {
                console.log('Cannot update Live Preview - missing subject or question index');
            }
        }
        
        function getCurrentSubject() {
            // Find which subject is currently active
            const activeInterface = document.querySelector('.inline-edit-interface[style*="display: block"], .inline-edit-interface:not([style*="display: none"])');
            console.log('Active interface found:', activeInterface);
            if (activeInterface) {
                const id = activeInterface.id;
                console.log('Interface ID:', id);
                if (id.includes('Mathematics')) return 'Mathematics';
                if (id.includes('Physics')) return 'Physics';
                if (id.includes('Chemistry')) return 'Chemistry';
            }
            return null;
        }
        
        function getCurrentQuestionIndex() {
            // Find the currently selected question
            const activeQuestion = document.querySelector('.question-item.active');
            console.log('Active question found:', activeQuestion);
            if (activeQuestion) {
                const text = activeQuestion.textContent;
                const index = parseInt(text) - 1; // Convert to 0-based index
                console.log('Question text:', text, 'Index:', index);
                return index;
            }
            console.log('No active question found, returning 0');
            return 0;
        }
        
        function toggleQuestionEdit(questionNumber, subject) {
            // This function can be used to toggle edit mode if needed
            console.log(`Toggling edit mode for question ${questionNumber} in ${subject}`);
        }
        
        let currentEditSubject = '';
        let originalQuestions = [];
        
        
        
        function populateInlineEditFields(subject) {
            const subjectQuestions = allQuestions.filter(q => {
                const assignedSubject = questionAssignments[q.number];
                const detectedSubject = q.subject;
                return assignedSubject === subject || 
                       (detectedSubject && detectedSubject.toLowerCase() === subject.toLowerCase());
            });
            
            const editQuestionsList = document.getElementById(`editQuestionsList-${subject}`);
            editQuestionsList.innerHTML = '';
            
            subjectQuestions.forEach(question => {
                const questionEditItem = document.createElement('div');
                questionEditItem.className = 'question-edit-item';
                
                const optionsHtml = question.options.map((opt, optIndex) => {
                    const letter = String.fromCharCode(65 + optIndex);
                    const cleanText = opt.replace(/^\(\d+\)\s*/, '').trim();
                    return `
                        <div class="option-edit-item">
                            <label>${letter}:</label>
                            <input type="text" class="option-edit-input" 
                                   data-question="${question.number}" data-option="${optIndex}"
                                   value="${cleanText}" oninput="updateInlineQuestionOption(${question.number}, ${optIndex}, this.value, '${subject}')">
                            
                            <!-- Option Image Upload -->
                            <div class="option-image-upload">
                                <div class="image-upload-area" 
                                     data-question="${question.number}" 
                                     data-option="${optIndex}"
                                     data-type="option"
                                     onclick="document.getElementById('option-image-input-${question.number}-${optIndex}').click()"
                                     ondrop="handleImageDrop(event, ${question.number}, 'option', ${optIndex})"
                                     ondragover="handleDragOver(event)"
                                     ondragleave="handleDragLeave(event)">
                                    <div class="image-upload-icon">📷</div>
                                    <div class="image-upload-text">Click or drag image</div>
                                    <div class="image-upload-hint">Single image for option ${letter}</div>
                                </div>
                                <input type="file" id="option-image-input-${question.number}-${optIndex}" 
                                       style="display: none;" 
                                       accept="image/*"
                                       onchange="handleOptionImageUpload(event, ${question.number}, ${optIndex})">
                                <div class="uploaded-images" id="option-images-${question.number}-${optIndex}">
                                    <!-- Uploaded image will appear here -->
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
                
                questionEditItem.innerHTML = `
                    <div class="question-edit-header">
                        <div class="question-edit-number">Question ${question.number}</div>
                    </div>
                    <div class="question-edit-fields">
                        <div class="edit-field-group">
                            <label>Question Text:</label>
                            <textarea class="question-edit-textarea" 
                                      data-question="${question.number}" 
                                      oninput="updateInlineQuestionText(${question.number}, this.value, '${subject}')">${question.text}</textarea>
                            
                            <!-- Question Images Upload -->
                            <div class="image-upload-section">
                                <label>Question Images (Multiple):</label>
                                <div class="image-upload-area" 
                                     data-question="${question.number}" 
                                     data-type="question"
                                     onclick="document.getElementById('question-image-input-${question.number}').click()"
                                     ondrop="handleImageDrop(event, ${question.number}, 'question')"
                                     ondragover="handleDragOver(event)"
                                     ondragleave="handleDragLeave(event)">
                                    <div class="image-upload-icon">📷</div>
                                    <div class="image-upload-text">Click or drag images here</div>
                                    <div class="image-upload-hint">Multiple images allowed</div>
                        </div>
                                <input type="file" id="question-image-input-${question.number}" 
                                       style="display: none;" 
                                       multiple 
                                       accept="image/*"
                                       onchange="handleQuestionImageUpload(event, ${question.number})">
                                <div class="uploaded-images" id="question-images-${question.number}">
                                    <!-- Uploaded images will appear here -->
                                </div>
                            </div>
                        </div>
                        
                        <div class="edit-field-group">
                            <label>Options:</label>
                            <div class="options-edit-grid">
                                ${optionsHtml}
                            </div>
                        </div>
                        
                        <div class="edit-field-group">
                            <label>Correct Answer:</label>
                            <select class="answer-edit-select" 
                                    data-question="${question.number}" 
                                    onchange="updateInlineQuestionAnswer(${question.number}, this.value, '${subject}')">
                                <option value="1" ${question.answer === '1' ? 'selected' : ''}>A</option>
                                <option value="2" ${question.answer === '2' ? 'selected' : ''}>B</option>
                                <option value="3" ${question.answer === '3' ? 'selected' : ''}>C</option>
                                <option value="4" ${question.answer === '4' ? 'selected' : ''}>D</option>
                            </select>
                        </div>
                        
                        <div class="edit-field-group">
                            <label>Solution:</label>
                            <textarea class="solution-edit-textarea" 
                                      data-question="${question.number}" 
                                      oninput="updateInlineQuestionSolution(${question.number}, this.value, '${subject}')">${question.solution || ''}</textarea>
                            
                            <!-- Solution Images Upload -->
                            <div class="image-upload-section">
                                <label>Solution Images (Multiple):</label>
                                <div class="image-upload-area" 
                                     data-question="${question.number}" 
                                     data-type="solution"
                                     onclick="document.getElementById('solution-image-input-${question.number}').click()"
                                     ondrop="handleImageDrop(event, ${question.number}, 'solution')"
                                     ondragover="handleDragOver(event)"
                                     ondragleave="handleDragLeave(event)">
                                    <div class="image-upload-icon">📷</div>
                                    <div class="image-upload-text">Click or drag images here</div>
                                    <div class="image-upload-hint">Multiple images allowed</div>
                                </div>
                                <input type="file" id="solution-image-input-${question.number}" 
                                       style="display: none;" 
                                       multiple 
                                       accept="image/*"
                                       onchange="handleSolutionImageUpload(event, ${question.number})">
                                <div class="uploaded-images" id="solution-images-${question.number}">
                                    <!-- Uploaded images will appear here -->
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                editQuestionsList.appendChild(questionEditItem);
            });
            
            // Populate the render view
            populateInlineRenderView(subject);
        }
        
        function updateInlinePreview(subject) {
            // Update the questions data with current form values
            const editFields = document.querySelectorAll(`#editQuestionsList-${subject} .question-edit-item`);
            
            editFields.forEach(editField => {
                const questionNumber = parseInt(editField.querySelector('[data-question]').getAttribute('data-question'));
                const question = allQuestions.find(q => q.number === questionNumber);
                
                if (question) {
                    // Update question text
                    const questionTextarea = editField.querySelector('.question-edit-textarea');
                    if (questionTextarea) {
                        question.text = questionTextarea.value;
                    }
                    
                    // Update options
                    const optionInputs = editField.querySelectorAll('.option-edit-input');
                    optionInputs.forEach((input, index) => {
                        const optionNumber = index + 1;
                        question.options[index] = `(${optionNumber}) ${input.value}`;
                    });
                    
                    // Update answer
                    const answerSelect = editField.querySelector('.answer-edit-select');
                    if (answerSelect) {
                        question.answer = answerSelect.value;
                    }
                    
                    // Update solution
                    const solutionTextarea = editField.querySelector('.solution-edit-textarea');
                    if (solutionTextarea) {
                        question.solution = solutionTextarea.value;
                    }
                }
            });
            
            // Update the main view
            displaySubjectJSON(subject);
            renderAllQuestions(subject);
        }
        
        function saveAllInlineChanges(subject) {
            // Auto-save is now handled by individual field updates
            // This function is kept for compatibility but does nothing
            console.log('Auto-save is enabled - changes are saved automatically');
        }
        
        function updateInlineQuestionText(questionNumber, newText, subject) {
            const question = allQuestions.find(q => q.number === questionNumber);
            if (question) {
                question.text = newText;
                populateInlineRenderView(subject);
            }
        }
        
        function updateInlineQuestionOption(questionNumber, optionIndex, newValue, subject) {
            const question = allQuestions.find(q => q.number === questionNumber);
            if (question) {
                const optionNumber = optionIndex + 1;
                question.options[optionIndex] = `(${optionNumber}) ${newValue}`;
                populateInlineRenderView(subject);
            }
        }
        
        function updateInlineQuestionAnswer(questionNumber, newAnswer, subject) {
            const question = allQuestions.find(q => q.number === questionNumber);
            if (question) {
                question.answer = newAnswer;
                populateInlineRenderView(subject);
            }
        }
        
        function updateInlineQuestionSolution(questionNumber, newSolution, subject) {
            const question = allQuestions.find(q => q.number === questionNumber);
            if (question) {
                question.solution = newSolution;
                populateInlineRenderView(subject);
            }
        }
        
        function populateInlineRenderView(subject) {
            const subjectQuestions = allQuestions.filter(q => {
                const assignedSubject = questionAssignments[q.number];
                const detectedSubject = q.subject;
                return assignedSubject === subject || 
                       (detectedSubject && detectedSubject.toLowerCase() === subject.toLowerCase());
            });
            
            let renderHtml = '';
            subjectQuestions.forEach(question => {
                const optionsHtml = question.options.map((opt, optIndex) => {
                    const letter = String.fromCharCode(65 + optIndex);
                    const cleanText = opt.replace(/^\(\d+\)\s*/, '').trim();
                    return `<div class="option-render"><strong>${letter}.</strong> ${cleanText}</div>`;
                }).join('\n');
                
                const answerIndex = parseInt(question.answer) - 1;
                const answerText = question.options[answerIndex]?.replace(/^\(\d+\)\s*/, '').trim() || '';
                const answerLetter = question.answer ? String.fromCharCode(64 + parseInt(question.answer)) : '';
                
                renderHtml += `
                    <div class="question-render" id="inline-render-q${question.number}">
                        <h4>Question ${question.number}</h4>
                        <div class="question-text">${question.text}</div>
                        <div class="options-render">${optionsHtml}</div>
                        ${answerText ? `<div class="answer-render">Answer: ${answerLetter}. ${answerText}</div>` : ''}
                        ${question.solution ? `<div class="solution-render">Solution: ${cleanSolutionText(question.solution)}</div>` : ''}
                        <hr style="margin: 20px 0; border: 1px solid #eee;">
                    </div>
                `;
            });
            
            const renderContainerId = subject === 'Mathematics' ? 'inlineMathRender' :
                                    subject === 'Physics' ? 'inlinePhysicsRender' : 'inlineChemistryRender';
            document.getElementById(renderContainerId).innerHTML = renderHtml;
            
            
            // Re-render MathJax
            if (typeof MathJax !== 'undefined') {
                MathJax.typesetPromise([document.getElementById(renderContainerId)]);
            }
        }
        
        function switchTab(subject, tabType) {
            // Tab switching is no longer needed - both panels are always visible
            console.log(`Inline layout - both panels always visible for ${subject}`);
        }
        
        function populateQuestionList(subject) {
            const questionListContainer = document.getElementById(`questionList-${subject}`);
            const subjectQuestions = allQuestions.filter(q => q.subject === subject.toLowerCase());
            
            console.log(`Populating question list for ${subject}`);
            console.log(`Total questions: ${allQuestions.length}`);
            console.log(`Questions for ${subject.toLowerCase()}: ${subjectQuestions.length}`);
            console.log(`All subjects found:`, [...new Set(allQuestions.map(q => q.subject))]);
            
            questionListContainer.innerHTML = '<h4>📋 Questions</h4>';
            
            if (subjectQuestions.length === 0) {
                questionListContainer.innerHTML += '<p style="text-align: center; color: #6c757d; margin-top: 20px;">No questions found</p>';
                return;
            }
            
            subjectQuestions.forEach((question, index) => {
                const questionItem = document.createElement('button');
                questionItem.className = 'question-item';
                questionItem.textContent = `${question.number}`;
                questionItem.onclick = () => selectQuestion(subject, index);
                questionListContainer.appendChild(questionItem);
            });
        }
        
        function selectQuestion(subject, questionIndex) {
            // Remove active class from all question items
            const questionItems = document.querySelectorAll(`#questionList-${subject} .question-item`);
            questionItems.forEach(item => item.classList.remove('active'));
            
            // Add active class to selected question
            questionItems[questionIndex].classList.add('active');
            
            // Show the viewer toggle and render panels
            document.getElementById(`viewerToggle-${subject}`).style.display = 'flex';
            document.getElementById(`questionRender-${subject}`).style.display = 'block';
            
            // Check which viewer is currently active and show only that one
            const editorPanel = document.getElementById(`questionEditor-${subject}`);
            const jsonPanel = document.getElementById(`jsonViewer-${subject}`);
            const renderPanel = document.getElementById(`questionRender-${subject}`);
            const toggleButtons = document.querySelectorAll(`#viewerToggle-${subject} .viewer-toggle-btn`);
            
            // Check if JSON viewer is active (has active class on second button)
            const isJsonViewerActive = toggleButtons[1] && toggleButtons[1].classList.contains('active');
            
            if (isJsonViewerActive) {
                // JSON viewer is active - show JSON panel and render panel
                editorPanel.style.display = 'none';
                jsonPanel.style.display = 'flex';
                renderPanel.style.display = 'block';
                generateJSONContent(subject);
            } else {
                // Question editor is active - show editor panel and render panel
                editorPanel.style.display = 'block';
                jsonPanel.style.display = 'none';
                renderPanel.style.display = 'block';
                generateQuestionEditor(subject, questionIndex);
            }
            
            // Always generate the render (Live Preview)
            generateQuestionRender(subject, questionIndex);
        }
        
        // JSON Viewer Functions
        function switchViewer(subject, viewerType) {
            const editorPanel = document.getElementById(`questionEditor-${subject}`);
            const jsonPanel = document.getElementById(`jsonViewer-${subject}`);
            const renderPanel = document.getElementById(`questionRender-${subject}`);
            const toggleButtons = document.querySelectorAll(`#viewerToggle-${subject} .viewer-toggle-btn`);
            
            // Remove active class from all toggle buttons
            toggleButtons.forEach(btn => btn.classList.remove('active'));
            
            if (viewerType === 'editor') {
                editorPanel.style.display = 'block';
                jsonPanel.style.display = 'none';
                renderPanel.style.display = 'block';
                toggleButtons[0].classList.add('active');
            } else if (viewerType === 'json') {
                editorPanel.style.display = 'none';
                jsonPanel.style.display = 'flex';
                renderPanel.style.display = 'block'; // Keep Live Preview visible
                toggleButtons[1].classList.add('active');
                
                // Generate JSON content when switching to JSON viewer
                generateJSONContent(subject);
            }
        }
        
        function generateJSONContent(subject) {
            const subjectQuestions = allQuestions.filter(q => q.subject === subject.toLowerCase());
            const jsonContent = document.getElementById(`jsonContent-${subject}`);
            
            if (subjectQuestions.length === 0) {
                jsonContent.textContent = 'No questions found for this subject.';
                return;
            }
            
            // Get metadata values from form inputs
            const getFormValue = (id) => {
                const element = document.getElementById(id);
                return element ? element.value : '';
            };
            
            const suffix = subject === 'Mathematics' ? '' : subject === 'Physics' ? '-physics' : '-chemistry';
            const tutorialId = getFormValue(`tutorialId${suffix}`);
            const tutorialTitle = getFormValue(`tutorialTitle${suffix}`);
            const tutorialDescription = getFormValue(`tutorialDescription${suffix}`);
            const authorityExamId = getFormValue(`authorityExamId${suffix}`);
            const state = getFormValue(`state${suffix}`);
            const board = getFormValue(`board${suffix}`);
            const conductedBy = getFormValue(`conductedBy${suffix}`);
            const year = getFormValue(`year${suffix}`);
            const subjectValue = getFormValue(`subject${suffix}`);
            
            // Create JSON in the specified format
            const jsonData = [
                {
                    "tutorialId": tutorialId || `${board || 'KCET'}_${year || '2025'}_${subject}`,
                    "tutorialTitle": tutorialTitle || `${board || 'KCET'} ${year || '2025'} ${subject}`,
                    "tutorialDescription": tutorialDescription || "",
                    "authorityExamId": authorityExamId || "kar_kect",
                    "state": state || "Karnataka",
                    "board": board || "KCET",
                    "conductedBy": conductedBy || "KEA (Karnataka Examinations Authority)",
                    "year": year || "2025",
                    "subject": subjectValue || subject,
                    "questions": subjectQuestions.map((question, index) => ({
                        "questionIndex": question.number.toString(),
                        "questionId": `2025${subject.charAt(0)}Q${question.number}`,
                        "questionDetails": [
                            {
                                "text": question.text || '',
                                "textImages": question.questionImages || [],
                                "possibleAnswers": {
                                    "A": {
                                        "text": question.options && question.options[0] ? question.options[0].replace(/^\(\d+\)\s*/, '').trim() : '',
                                        "image": question.optionImages && question.optionImages[0] ? question.optionImages[0] : null
                                    },
                                    "B": {
                                        "text": question.options && question.options[1] ? question.options[1].replace(/^\(\d+\)\s*/, '').trim() : '',
                                        "image": question.optionImages && question.optionImages[1] ? question.optionImages[1] : null
                                    },
                                    "C": {
                                        "text": question.options && question.options[2] ? question.options[2].replace(/^\(\d+\)\s*/, '').trim() : '',
                                        "image": question.optionImages && question.optionImages[2] ? question.optionImages[2] : null
                                    },
                                    "D": {
                                        "text": question.options && question.options[3] ? question.options[3].replace(/^\(\d+\)\s*/, '').trim() : '',
                                        "image": question.optionImages && question.optionImages[3] ? question.optionImages[3] : null
                                    }
                                },
                                "correctAnswer": question.answer || '',
                                "correctAnswerText": question.options && question.answer && question.options[parseInt(question.answer) - 1] ? 
                                    question.options[parseInt(question.answer) - 1].replace(/^\(\d+\)\s*/, '').trim() : '',
                                "solution": question.solution || '',
                                "solutionImages": question.solutionImages || [],
                                "type": question.type || "mcq",
                                "metadata": {
                                    "subject": subject.toLowerCase(),
                                    "number": question.number || (index + 1)
                                }
                            }
                        ]
                    }))
                }
            ];
            
            // Format JSON with proper indentation
            jsonContent.textContent = JSON.stringify(jsonData, null, 2);
        }
        
        function copyJSON(subject) {
            const jsonContent = document.getElementById(`jsonContent-${subject}`);
            const text = jsonContent.textContent;
            
            navigator.clipboard.writeText(text).then(() => {
                // Show success feedback
                const button = event.target;
                const originalText = button.textContent;
                button.textContent = '✅ Copied!';
                button.style.background = 'var(--success-color)';
                
                setTimeout(() => {
                    button.textContent = originalText;
                    button.style.background = '';
                }, 2000);
            }).catch(err => {
                console.error('Failed to copy JSON:', err);
                alert('Failed to copy JSON to clipboard');
            });
        }
        
        function downloadJSON(subject) {
            const jsonContent = document.getElementById(`jsonContent-${subject}`);
            const text = jsonContent.textContent;
            
            // Get metadata values from form inputs
            const getFormValue = (id) => {
                const element = document.getElementById(id);
                return element ? element.value : '';
            };
            
            const suffix = subject === 'Mathematics' ? '' : subject === 'Physics' ? '-physics' : '-chemistry';
            const yearValue = getFormValue(`year${suffix}`) || '2025';
            const boardValue = getFormValue(`board${suffix}`) || 'KCET';
            const subjectLower = subject.toLowerCase();
            const filename = `${yearValue}_${boardValue.toLowerCase().replace(/\s+/g, '_')}_${subjectLower}.json`;
            
            const blob = new Blob([text], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
        
        function refreshJSON(subject) {
            generateJSONContent(subject);
            
            // Show success feedback
            const button = event.target;
            const originalText = button.textContent;
            button.textContent = '✅ Refreshed!';
            button.style.background = 'var(--success-color)';
            
            setTimeout(() => {
                button.textContent = originalText;
                button.style.background = '';
            }, 2000);
        }
        
        function generateQuestionEditor(subject, questionIndex) {
            const subjectQuestions = allQuestions.filter(q => q.subject === subject.toLowerCase());
            const question = subjectQuestions[questionIndex];
            
            if (!question) return;
            
            const editorContainer = document.getElementById(`editQuestionsList-${subject}`);
            editorContainer.innerHTML = `
                <div class="question-edit-item">
                    <h5>Question ${question.number}</h5>
                    <div class="edit-field">
                        <label>Question Type:</label>
                        <select class="answer-edit-select" 
                                onchange="updateQuestion(${question.number}, 'type', this.value)">
                            <option value="mcq" ${question.type === 'mcq' ? 'selected' : ''}>MCQ</option>
                            <option value="integer" ${question.type === 'integer' ? 'selected' : ''}>Integer</option>
                            <option value="truefalse" ${question.type === 'truefalse' ? 'selected' : ''}>True/False</option>
                            <option value="fillblank" ${question.type === 'fillblank' ? 'selected' : ''}>Fill in the Blank</option>
                        </select>
                    </div>
                    
                    <div class="edit-field">
                        <label>Question Text:</label>
                        <textarea class="question-edit-input" oninput="updateQuestion(${question.number}, 'text', this.value)">${question.text || ''}</textarea>
                    </div>
                    
                    <div class="image-upload-section">
                        <label>Question Images (Multiple):</label>
                        <div class="image-upload-area" onclick="document.getElementById('question-image-input-${question.number}').click()" ondrop="handleImageDrop(event, ${question.number}, 'question')" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)">
                            <div class="image-upload-icon">📷</div>
                            <div class="image-upload-text">Click or drag images here</div>
                            <div class="image-upload-hint">Multiple images allowed</div>
                            <input type="file" id="question-image-input-${question.number}" multiple accept="image/*" onchange="handleQuestionImageUpload(event, ${question.number})" style="display: none;">
                        </div>
                        <div class="uploaded-images" id="question-images-${question.number}">
                            ${(question.questionImages || []).map((img, idx) => `
                                <div class="uploaded-image">
                                    <img src="${img}" alt="Question image">
                                    <button class="remove-image" onclick="removeImage(${question.number}, 'question', this, ${idx})">×</button>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    
                    <div class="edit-field">
                        <label>Options:</label>
                        <div class="options-edit-grid">
                            ${['A', 'B', 'C', 'D'].map((option, idx) => `
                                <div class="option-edit-item">
                                    <label>${option}:</label>
                                    <input type="text" class="option-edit-input" value="${question.options && question.options[idx] ? question.options[idx].replace(/^\(\d+\)\s*/, '').trim() : ''}" oninput="updateQuestion(${question.number}, 'option', this.value, ${idx})">
                                    <div class="option-image-upload">
                                        <div class="image-upload-area" onclick="document.getElementById('option-image-input-${question.number}-${idx}').click()" ondrop="handleImageDrop(event, ${question.number}, 'option', ${idx})" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)">
                                            <div class="image-upload-icon">📷</div>
                                            <div class="image-upload-text">Option Image</div>
                                            <input type="file" id="option-image-input-${question.number}-${idx}" accept="image/*" onchange="handleOptionImageUpload(event, ${question.number}, ${idx})" style="display: none;">
                                        </div>
                                        <div class="uploaded-images" id="option-images-${question.number}-${idx}">
                                            ${question.optionImages && question.optionImages[idx] ? `
                                                <div class="uploaded-image">
                                                    <img src="${question.optionImages[idx]}" alt="Option image">
                                                    <button class="remove-image" onclick="removeImage(${question.number}, 'option', this, ${idx})">×</button>
                                                </div>
                                            ` : ''}
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    
                    <div class="edit-field">
                        <label>Correct Answer:</label>
                        <select class="answer-edit-select" onchange="updateQuestion(${question.number}, 'answer', this.value)">
                            <option value="A" ${question.answer === 'A' ? 'selected' : ''}>A</option>
                            <option value="B" ${question.answer === 'B' ? 'selected' : ''}>B</option>
                            <option value="C" ${question.answer === 'C' ? 'selected' : ''}>C</option>
                            <option value="D" ${question.answer === 'D' ? 'selected' : ''}>D</option>
                        </select>
                    </div>
                    
                    <div class="edit-field">
                        <label>Solution:</label>
                        <textarea class="solution-edit-input" oninput="updateQuestion(${question.number}, 'solution', this.value)">${question.solution || ''}</textarea>
                    </div>
                    
                    <div class="image-upload-section">
                        <label>Solution Images (Multiple):</label>
                        <div class="image-upload-area" onclick="document.getElementById('solution-image-input-${question.number}').click()" ondrop="handleImageDrop(event, ${question.number}, 'solution')" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)">
                            <div class="image-upload-icon">📷</div>
                            <div class="image-upload-text">Click or drag images here</div>
                            <div class="image-upload-hint">Multiple images allowed</div>
                            <input type="file" id="solution-image-input-${question.number}" multiple accept="image/*" onchange="handleSolutionImageUpload(event, ${question.number})" style="display: none;">
                        </div>
                        <div class="uploaded-images" id="solution-images-${question.number}">
                            ${(question.solutionImages || []).map((img, idx) => `
                                <div class="uploaded-image">
                                    <img src="${img}" alt="Solution image">
                                    <button class="remove-image" onclick="removeImage(${question.number}, 'solution', this, ${idx})">×</button>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
        }
        
        function generateQuestionRender(subject, questionIndex) {
            const subjectQuestions = allQuestions.filter(q => q.subject === subject.toLowerCase());
            
            if (subjectQuestions.length === 0) return;
            
            // Map subject names to correct container IDs
            const containerIdMap = {
                'Mathematics': 'inlineMathRender',
                'Physics': 'inlinePhysicsRender', 
                'Chemistry': 'inlineChemistryRender'
            };
            
            const renderContainer = document.getElementById(containerIdMap[subject]);
            
            // Generate HTML for all questions
            let allQuestionsHTML = '';
            subjectQuestions.forEach((question, index) => {
                const isActive = index === questionIndex;
                    allQuestionsHTML += `
                        <div class="question-render-item ${isActive ? 'active-question' : ''}" id="render-question-${index}">
                            <h5>Question ${question.number}</h5>
                            <div class="question-type" style="margin-bottom: 12px; padding: 6px 12px; background: var(--primary-color); color: white; border-radius: var(--radius-sm); display: inline-block; font-size: 12px; font-weight: 600; text-transform: uppercase;">
                                Type: ${question.type || 'mcq'}
                            </div>
                            <div class="question-text">${question.text || ''}</div>
                        
                        ${(question.questionImages || []).map(img => `<img src="${img}" alt="Question image" style="max-width: 100%; margin: 10px 0;">`).join('')}
                        
                        <div class="options">
                            ${['A', 'B', 'C', 'D'].map((option, idx) => `
                                <div class="option">
                                    <strong>${option}.</strong> ${question.options && question.options[idx] ? question.options[idx].replace(/^\(\d+\)\s*/, '').trim() : ''}
                                    ${question.optionImages && question.optionImages[idx] ? `<img src="${question.optionImages[idx]}" alt="Option image" style="max-width: 100px; margin-left: 10px;">` : ''}
                                </div>
                            `).join('')}
                        </div>
                        
                        <div class="answer" style="color: green; font-weight: bold; margin: 15px 0;">
                            Answer: ${question.answer || ''}
                        </div>
                        
                        <div class="solution">
                            <strong>Solution:</strong>
                            <div>${question.solution || ''}</div>
                            ${(question.solutionImages || []).map(img => `<img src="${img}" alt="Solution image" style="max-width: 100%; margin: 10px 0;">`).join('')}
                        </div>
                    </div>
                `;
            });
            
            renderContainer.innerHTML = allQuestionsHTML;
            
            // Scroll to the selected question
            setTimeout(() => {
                const targetQuestion = document.getElementById(`render-question-${questionIndex}`);
                if (targetQuestion) {
                    targetQuestion.scrollIntoView({ 
                        behavior: 'smooth', 
                        block: 'start',
                        inline: 'nearest'
                    });
                }
            }, 100);
            
            // Re-render MathJax
            if (typeof MathJax !== 'undefined') {
                MathJax.typesetPromise([renderContainer]);
            }
        }
        
        function generateSubjectJSON(subject) {
            console.log(`generateSubjectJSON called for ${subject}`);
            console.log(`Total questions: ${allQuestions.length}`);
            
            // Filter questions for this subject
            const subjectQuestions = allQuestions.filter(q => {
                const assignedSubject = questionAssignments[q.number];
                const detectedSubject = q.subject;
                return assignedSubject === subject || 
                       (detectedSubject && detectedSubject.toLowerCase() === subject.toLowerCase()) ||
                       (subject === 'Mathematics' && (!assignedSubject && !detectedSubject)) ||
                       (subject === 'Physics' && (!assignedSubject && !detectedSubject)) ||
                       (subject === 'Chemistry' && (!assignedSubject && !detectedSubject));
            });
            
            console.log(`Filtered questions for ${subject}: ${subjectQuestions.length}`);
            
            if (subjectQuestions.length === 0) {
                const jsonOutput = document.getElementById(`json-output-${subject}`);
                if (jsonOutput) {
                    jsonOutput.value = 'No questions found.';
                } else {
                    console.error(`JSON output element not found for ${subject}`);
                }
                return;
            }
            
            // Get values from form inputs
            const getFormValue = (fieldId) => {
                const element = document.getElementById(fieldId);
                return element ? element.value : '';
            };
            
            const suffix = subject === 'Mathematics' ? '' : subject === 'Physics' ? '-physics' : '-chemistry';
            const tutorialId = getFormValue(`tutorialId${suffix}`);
            const tutorialTitle = getFormValue(`tutorialTitle${suffix}`);
            const tutorialDescription = getFormValue(`tutorialDescription${suffix}`);
            const authorityExamId = getFormValue(`authorityExamId${suffix}`);
            const state = getFormValue(`state${suffix}`);
            const board = getFormValue(`board${suffix}`);
            const conductedBy = getFormValue(`conductedBy${suffix}`);
            const year = getFormValue(`year${suffix}`);
            const subjectValue = getFormValue(`subject${suffix}`);
            
            // Generate JSON structure in the required format
            const jsonData = [{
                "tutorialId": `JEE_2025_${subject}`,
                "tutorialTitle": `JEE 2025 ${subject}`,
                "tutorialDescription": `JEE 2025 ${subject} Questions with Solutions`,
                "authorityExamId": "jee_main",
                "state": "All India",
                "board": "JEE",
                "conductedBy": "NTA (National Testing Agency)",
                "year": "2025",
                "subject": subject,
                "questions": subjectQuestions.map(question => ({
                    "questionIndex": question.number.toString(),
                    "questionId": `2025${subject.charAt(0)}Q${question.number}`,
                    "questionDetails": [{
                        "text": question.text || "No text",
                        "textImages": [],
                        "possibleAnswers": {
                            "A": {
                                "text": question.options[0]?.replace(/^\(\d+\)\s*/, '').trim() || "",
                                "image": null
                            },
                            "B": {
                                "text": question.options[1]?.replace(/^\(\d+\)\s*/, '').trim() || "",
                                "image": null
                            },
                            "C": {
                                "text": question.options[2]?.replace(/^\(\d+\)\s*/, '').trim() || "",
                                "image": null
                            },
                            "D": {
                                "text": question.options[3]?.replace(/^\(\d+\)\s*/, '').trim() || "",
                                "image": null
                            }
                        },
                        "correctAnswer": question.answer ? String.fromCharCode(64 + parseInt(question.answer)) : "",
                        "correctAnswerText": question.options[parseInt(question.answer) - 1]?.replace(/^\(\d+\)\s*/, '').trim() || ""
                    }]
                }))
            }];
            
            // Display JSON in the main textarea
            const jsonOutput = document.getElementById(`json-output-${subject}`);
            console.log(`JSON output element found:`, jsonOutput);
            
            if (jsonOutput) {
                const jsonString = JSON.stringify(jsonData, null, 2);
                console.log(`JSON string length: ${jsonString.length}`);
                console.log(`JSON content preview:`, jsonString.substring(0, 200));
                jsonOutput.value = jsonString;
                console.log(`JSON set in textarea for ${subject}`);
                
                // Force a visual update
                jsonOutput.style.backgroundColor = '#f0f0f0';
                setTimeout(() => {
                    jsonOutput.style.backgroundColor = '#ffffff';
                }, 100);
            } else {
                console.error(`JSON output element not found for ${subject}`);
            }
            
        }
        
        
        function generateAllJSON() {
            const subjects = ['Mathematics', 'Physics', 'Chemistry'];
            const allJsonData = [];
            
            subjects.forEach(subject => {
                // Get questions assigned to this subject OR detected as this subject
                const subjectQuestions = allQuestions.filter(q => {
                    const assignedSubject = questionAssignments[q.number];
                    const detectedSubject = q.subject;
                    return assignedSubject === subject || 
                           (detectedSubject === subject.toLowerCase() && !assignedSubject) ||
                           (detectedSubject === 'mathematics' && subject === 'Mathematics') ||
                           (detectedSubject === 'physics' && subject === 'Physics') ||
                           (detectedSubject === 'chemistry' && subject === 'Chemistry');
                });
                
                if (subjectQuestions.length > 0) {
                    allJsonData.push({
                        "tutorialId": `JEE_2025_${subject}`,
                        "tutorialTitle": `JEE 2025 ${subject}`,
                        "tutorialDescription": `JEE (Main) 2025 ${subject} Questions`,
                        "authorityExamId": "jee_main",
                        "state": "All India",
                        "board": "JEE",
                        "conductedBy": "NTA (National Testing Agency)",
                        "year": "2025",
                        "subject": subject,
                        "questions": subjectQuestions.map((q, index) => ({
                            "questionIndex": q.number.toString(),
                            "questionId": `2025${subject.charAt(0)}Q${q.number}`,
                            "questionDetails": [{
                                "text": q.text,
                                "textImages": [],
                                "possibleAnswers": q.options.reduce((acc, opt) => {
                                    const letter = String.fromCharCode(64 + parseInt(opt.number));
                                    acc[letter] = { 
                                        "text": opt.text, 
                                        "image": null 
                                    };
                                    return acc;
                                }, {}),
                                "correctAnswer": q.answer ? String.fromCharCode(64 + parseInt(q.answer)) : "",
                                "correctAnswerText": q.options.find(opt => opt.number === q.answer)?.text || ""
                            }]
                        }))
                    });
                }
            });
            
            // Show JSON in a new window
            const jsonWindow = window.open('', '_blank');
            jsonWindow.document.write(`
                <html>
                <head>
                    <title>All Subjects JSON - JEE 2025</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 20px; }
                        pre { background: #f5f5f5; padding: 20px; border-radius: 5px; overflow-x: auto; }
                        .header { background: #4facfe; color: white; padding: 20px; border-radius: 10px; margin-bottom: 20px; }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>All Subjects - JEE 2025</h1>
                        <p>Total Subjects: ${allJsonData.length}</p>
                    </div>
                    <pre>${JSON.stringify(allJsonData, null, 2)}</pre>
                </body>
                </html>
            `);
        }
        
        function downloadSubjectJSON(subject) {
            console.log(`Downloading JSON for ${subject}`);
            
            // Filter questions for this subject
            const subjectQuestions = allQuestions.filter(q => q.subject === subject.toLowerCase());
            
            if (subjectQuestions.length === 0) {
                alert(`No questions found for ${subject}. Please assign some questions to this subject first.`);
                return;
            }
            
            // Get metadata values from form inputs
            const getFormValue = (id) => {
                const element = document.getElementById(id);
                return element ? element.value : '';
            };
            
            const suffix = subject === 'Mathematics' ? '' : subject === 'Physics' ? '-physics' : '-chemistry';
            const tutorialId = getFormValue(`tutorialId${suffix}`);
            const tutorialTitle = getFormValue(`tutorialTitle${suffix}`);
            const tutorialDescription = getFormValue(`tutorialDescription${suffix}`);
            const authorityExamId = getFormValue(`authorityExamId${suffix}`);
            const state = getFormValue(`state${suffix}`);
            const board = getFormValue(`board${suffix}`);
            const conductedBy = getFormValue(`conductedBy${suffix}`);
            const year = getFormValue(`year${suffix}`);
            const subjectValue = getFormValue(`subject${suffix}`);
            
            // Generate JSON structure in the specified format
            const jsonData = [
                {
                    "tutorialId": tutorialId || `${board || 'KCET'}_${year || '2025'}_${subject}`,
                    "tutorialTitle": tutorialTitle || `${board || 'KCET'} ${year || '2025'} ${subject}`,
                    "tutorialDescription": tutorialDescription || "",
                    "authorityExamId": authorityExamId || "kar_kect",
                    "state": state || "Karnataka",
                    "board": board || "KCET",
                    "conductedBy": conductedBy || "KEA (Karnataka Examinations Authority)",
                    "year": year || "2025",
                    "subject": subjectValue || subject,
                    "questions": subjectQuestions.map((question, index) => ({
                        "questionIndex": question.number.toString(),
                        "questionId": `2025${subject.charAt(0)}Q${question.number}`,
                        "questionDetails": [
                            {
                                "text": question.text || '',
                                "textImages": question.questionImages || [],
                                "possibleAnswers": {
                                    "A": {
                                        "text": question.options && question.options[0] ? question.options[0].replace(/^\(\d+\)\s*/, '').trim() : '',
                                        "image": question.optionImages && question.optionImages[0] ? question.optionImages[0] : null
                                    },
                                    "B": {
                                        "text": question.options && question.options[1] ? question.options[1].replace(/^\(\d+\)\s*/, '').trim() : '',
                                        "image": question.optionImages && question.optionImages[1] ? question.optionImages[1] : null
                                    },
                                    "C": {
                                        "text": question.options && question.options[2] ? question.options[2].replace(/^\(\d+\)\s*/, '').trim() : '',
                                        "image": question.optionImages && question.optionImages[2] ? question.optionImages[2] : null
                                    },
                                    "D": {
                                        "text": question.options && question.options[3] ? question.options[3].replace(/^\(\d+\)\s*/, '').trim() : '',
                                        "image": question.optionImages && question.optionImages[3] ? question.optionImages[3] : null
                                    }
                                },
                                "correctAnswer": question.answer || '',
                                "correctAnswerText": question.options && question.answer && question.options[parseInt(question.answer) - 1] ? 
                                    question.options[parseInt(question.answer) - 1].replace(/^\(\d+\)\s*/, '').trim() : '',
                                "solution": question.solution || '',
                                "solutionImages": question.solutionImages || [],
                                "type": question.type || "mcq",
                                "metadata": {
                                    "subject": subject.toLowerCase(),
                                    "number": question.number || (index + 1)
                                }
                            }
                        ]
                    }))
                }
            ];
            
                // Create and download the file
                const jsonString = JSON.stringify(jsonData, null, 2);
                const blob = new Blob([jsonString], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                
                // Generate dynamic filename based on form values
                const yearValue = year || '2025';
                const boardValue = board || 'KCET';
                const subjectLower = subject.toLowerCase();
                const filename = `${yearValue}_${boardValue.toLowerCase().replace(/\s+/g, '_')}_${subjectLower}.json`;
                
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            
            console.log(`Downloaded JSON for ${subject} with ${subjectQuestions.length} questions`);
        }
        
        function downloadAllSubjectsJSON() {
            console.log('Downloading JSON for all subjects');
            
            const subjects = ['Mathematics', 'Physics', 'Chemistry'];
            const allJsonData = [];
            
            // Get metadata values from form inputs
            const getFormValue = (id) => {
                const element = document.getElementById(id);
                return element ? element.value : '';
            };
            
            subjects.forEach(subject => {
                const subjectQuestions = allQuestions.filter(q => q.subject === subject.toLowerCase());
                
                if (subjectQuestions.length > 0) {
                    const suffix = subject === 'Mathematics' ? '' : subject === 'Physics' ? '-physics' : '-chemistry';
                    const tutorialId = getFormValue(`tutorialId${suffix}`);
                    const tutorialTitle = getFormValue(`tutorialTitle${suffix}`);
                    const tutorialDescription = getFormValue(`tutorialDescription${suffix}`);
                    const authorityExamId = getFormValue(`authorityExamId${suffix}`);
                    const state = getFormValue(`state${suffix}`);
                    const board = getFormValue(`board${suffix}`);
                    const conductedBy = getFormValue(`conductedBy${suffix}`);
                    const year = getFormValue(`year${suffix}`);
                    const subjectValue = getFormValue(`subject${suffix}`);
                    
                    allJsonData.push({
                        "tutorialId": tutorialId || `${board || 'KCET'}_${year || '2025'}_${subject}`,
                        "tutorialTitle": tutorialTitle || `${board || 'KCET'} ${year || '2025'} ${subject}`,
                        "tutorialDescription": tutorialDescription || "",
                        "authorityExamId": authorityExamId || "kar_kect",
                        "state": state || "Karnataka",
                        "board": board || "KCET",
                        "conductedBy": conductedBy || "KEA (Karnataka Examinations Authority)",
                        "year": year || "2025",
                        "subject": subjectValue || subject,
                        "questions": subjectQuestions.map((question, index) => ({
                            "questionIndex": (index + 1).toString(),
                            "questionId": `2025${subject.charAt(0)}Q${index + 1}`,
                            "questionDetails": [
                                {
                                    "text": question.text || '',
                                    "textImages": question.questionImages || [],
                                    "possibleAnswers": {
                                        "A": {
                                            "text": question.options && question.options[0] ? question.options[0].replace(/^\(\d+\)\s*/, '').trim() : '',
                                            "image": question.optionImages && question.optionImages[0] ? question.optionImages[0] : null
                                        },
                                        "B": {
                                            "text": question.options && question.options[1] ? question.options[1].replace(/^\(\d+\)\s*/, '').trim() : '',
                                            "image": question.optionImages && question.optionImages[1] ? question.optionImages[1] : null
                                        },
                                        "C": {
                                            "text": question.options && question.options[2] ? question.options[2].replace(/^\(\d+\)\s*/, '').trim() : '',
                                            "image": question.optionImages && question.optionImages[2] ? question.optionImages[2] : null
                                        },
                                        "D": {
                                            "text": question.options && question.options[3] ? question.options[3].replace(/^\(\d+\)\s*/, '').trim() : '',
                                            "image": question.optionImages && question.optionImages[3] ? question.optionImages[3] : null
                                        }
                                    },
                                    "correctAnswer": question.answer || '',
                                    "correctAnswerText": question.options && question.answer && question.options[parseInt(question.answer) - 1] ? 
                                        question.options[parseInt(question.answer) - 1].replace(/^\(\d+\)\s*/, '').trim() : '',
                                    "solution": question.solution || '',
                                    "solutionImages": question.solutionImages || [],
                                    "metadata": {
                                        "subject": subject.toLowerCase(),
                                        "number": question.number || (index + 1)
                                    }
                                }
                            ]
                        }))
                    });
                }
            });
            
            if (allJsonData.length === 0) {
                alert('No questions found for any subject. Please assign some questions first.');
                return;
            }
            
                // Create and download the file
                const jsonString = JSON.stringify(allJsonData, null, 2);
                const blob = new Blob([jsonString], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                
                // Generate dynamic filename based on form values (use Mathematics as reference)
                const yearValue = getFormValue('year') || '2025';
                const boardValue = getFormValue('board') || 'KCET';
                const filename = `${yearValue}_${boardValue.toLowerCase().replace(/\s+/g, '_')}_all_subjects.json`;
                
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            
            console.log(`Downloaded JSON for all subjects with ${allJsonData.length} subject files`);
        }
        
        // Image Upload Functions
        function handleDragOver(event) {
            event.preventDefault();
            event.currentTarget.classList.add('dragover');
        }
        
        function handleDragLeave(event) {
            event.currentTarget.classList.remove('dragover');
        }
        
        function handleImageDrop(event, questionNumber, type, optionIndex = null) {
            event.preventDefault();
            event.currentTarget.classList.remove('dragover');
            
            const files = event.dataTransfer.files;
            if (files.length > 0) {
                if (type === 'option' && optionIndex !== null) {
                    handleOptionImageUpload({ target: { files: [files[0]] } }, questionNumber, optionIndex);
                } else if (type === 'question') {
                    handleQuestionImageUpload({ target: { files: files } }, questionNumber);
                } else if (type === 'solution') {
                    handleSolutionImageUpload({ target: { files: files } }, questionNumber);
                }
            }
        }
        
        function handleQuestionImageUpload(event, questionNumber) {
            const files = event.target.files;
            const container = document.getElementById(`question-images-${questionNumber}`);
            const question = allQuestions.find(q => q.number === questionNumber);
            
            if (!question) {
                console.error('Question not found:', questionNumber);
                return;
            }
            
            // Initialize questionImages array if it doesn't exist
            if (!question.questionImages) {
                question.questionImages = [];
            }
            
            Array.from(files).forEach((file, fileIndex) => {
                if (file.type.startsWith('image/')) {
                    const imgIndex = question.questionImages.length;
                    const suffix = `_Q${imgIndex + 1}`;
                    
                    // Create progress container
                    const progressContainer = document.createElement('div');
                    progressContainer.className = 'upload-progress';
                    progressContainer.innerHTML = `
                        <div class="progress-bar">
                            <div class="progress-fill"></div>
                        </div>
                        <div class="progress-text">0%</div>
                        <div class="upload-status uploading">Uploading...</div>
                    `;
                    container.appendChild(progressContainer);
                    
                    const progressFill = progressContainer.querySelector('.progress-fill');
                    const progressText = progressContainer.querySelector('.progress-text');
                    const uploadStatus = progressContainer.querySelector('.upload-status');
                    
                    // Get current subject and year for Firebase path
                    const currentSubject = getCurrentSubject();
                    const year = '2025'; // You can make this dynamic if needed
                    
                    // Upload to Firebase
                    uploadImageToFirebase(file, currentSubject, year, questionNumber - 1, suffix, (percent) => {
                        progressFill.style.width = percent + '%';
                        progressText.textContent = percent + '%';
                    }).then(url => {
                        // Upload successful
                        uploadStatus.textContent = '✅ Uploaded';
                        uploadStatus.className = 'upload-status success';
                        
                        // Create image display
                        const imageDiv = document.createElement('div');
                        imageDiv.className = 'uploaded-image';
                        imageDiv.innerHTML = `
                            <img src="${url}" alt="Question Image">
                            <button class="remove-image" onclick="removeImage(${questionNumber}, 'question', this, ${imgIndex})">×</button>
                        `;
                        
                        // Replace progress with image
                        progressContainer.replaceWith(imageDiv);
                        
                        // Store Firebase URL in question object
                        question.questionImages.push(url);
                        
                        // Update Live Preview
                        updateLivePreview();
                        
                    }).catch(error => {
                        console.error('Upload failed:', error);
                        uploadStatus.textContent = '❌ Upload failed';
                        uploadStatus.className = 'upload-status error';
                    });
                }
            });
            
            // Reset file input
            event.target.value = '';
        }
        
        function handleOptionImageUpload(event, questionNumber, optionIndex) {
            const file = event.target.files[0];
            if (file && file.type.startsWith('image/')) {
                const container = document.getElementById(`option-images-${questionNumber}-${optionIndex}`);
                const question = allQuestions.find(q => q.number === questionNumber);
                
                if (!question) {
                    console.error('Question not found:', questionNumber);
                    return;
                }
                
                // Clear existing image for this option
                container.innerHTML = '';
                
                // Create progress container
                const progressContainer = document.createElement('div');
                progressContainer.className = 'upload-progress';
                progressContainer.innerHTML = `
                    <div class="progress-bar">
                        <div class="progress-fill"></div>
                    </div>
                    <div class="progress-text">0%</div>
                    <div class="upload-status uploading">Uploading...</div>
                `;
                container.appendChild(progressContainer);
                
                const progressFill = progressContainer.querySelector('.progress-fill');
                const progressText = progressContainer.querySelector('.progress-text');
                const uploadStatus = progressContainer.querySelector('.upload-status');
                
                // Get current subject and year for Firebase path
                const currentSubject = getCurrentSubject();
                const year = '2025'; // You can make this dynamic if needed
                const suffix = `_op${optionIndex + 1}`;
                
                // Upload to Firebase
                uploadImageToFirebase(file, currentSubject, year, questionNumber - 1, suffix, (percent) => {
                    progressFill.style.width = percent + '%';
                    progressText.textContent = percent + '%';
                }).then(url => {
                    // Upload successful
                    uploadStatus.textContent = '✅ Uploaded';
                    uploadStatus.className = 'upload-status success';
                    
                    // Create image display
                    const imageDiv = document.createElement('div');
                    imageDiv.className = 'uploaded-image';
                    imageDiv.innerHTML = `
                        <img src="${url}" alt="Option Image">
                        <button class="remove-image" onclick="removeImage(${questionNumber}, 'option', this, ${optionIndex})">×</button>
                    `;
                    
                    // Replace progress with image
                    progressContainer.replaceWith(imageDiv);
                    
                    // Store Firebase URL in question object
                    if (!question.optionImages) {
                        question.optionImages = {};
                    }
                    question.optionImages[optionIndex] = url;
                    
                    // Update Live Preview
                    updateLivePreview();
                    
                }).catch(error => {
                    console.error('Upload failed:', error);
                    uploadStatus.textContent = '❌ Upload failed';
                    uploadStatus.className = 'upload-status error';
                });
            }
        }
        
        function handleSolutionImageUpload(event, questionNumber) {
            const files = event.target.files;
            const container = document.getElementById(`solution-images-${questionNumber}`);
            const question = allQuestions.find(q => q.number === questionNumber);
            
            if (!question) {
                console.error('Question not found:', questionNumber);
                return;
            }
            
            // Initialize solutionImages array if it doesn't exist
            if (!question.solutionImages) {
                question.solutionImages = [];
            }
            
            Array.from(files).forEach((file, fileIndex) => {
                if (file.type.startsWith('image/')) {
                    const imgIndex = question.solutionImages.length;
                    const suffix = `_S${imgIndex + 1}`;
                    
                    // Create progress container
                    const progressContainer = document.createElement('div');
                    progressContainer.className = 'upload-progress';
                    progressContainer.innerHTML = `
                        <div class="progress-bar">
                            <div class="progress-fill"></div>
                        </div>
                        <div class="progress-text">0%</div>
                        <div class="upload-status uploading">Uploading...</div>
                    `;
                    container.appendChild(progressContainer);
                    
                    const progressFill = progressContainer.querySelector('.progress-fill');
                    const progressText = progressContainer.querySelector('.progress-text');
                    const uploadStatus = progressContainer.querySelector('.upload-status');
                    
                    // Get current subject and year for Firebase path
                    const currentSubject = getCurrentSubject();
                    const year = '2025'; // You can make this dynamic if needed
                    
                    // Upload to Firebase
                    uploadImageToFirebase(file, currentSubject, year, questionNumber - 1, suffix, (percent) => {
                        progressFill.style.width = percent + '%';
                        progressText.textContent = percent + '%';
                    }).then(url => {
                        // Upload successful
                        uploadStatus.textContent = '✅ Uploaded';
                        uploadStatus.className = 'upload-status success';
                        
                        // Create image display
                        const imageDiv = document.createElement('div');
                        imageDiv.className = 'uploaded-image';
                        imageDiv.innerHTML = `
                            <img src="${url}" alt="Solution Image">
                            <button class="remove-image" onclick="removeImage(${questionNumber}, 'solution', this, ${imgIndex})">×</button>
                        `;
                        
                        // Replace progress with image
                        progressContainer.replaceWith(imageDiv);
                        
                        // Store Firebase URL in question object
                        question.solutionImages.push(url);
                        
                        // Update Live Preview
                        updateLivePreview();
                        
                    }).catch(error => {
                        console.error('Upload failed:', error);
                        uploadStatus.textContent = '❌ Upload failed';
                        uploadStatus.className = 'upload-status error';
                    });
                }
            });
            
            // Reset file input
            event.target.value = '';
        }
        
        // Prevent default drag and drop behavior on the entire page
        document.addEventListener('dragover', function(e) {
            e.preventDefault();
        });
        
        document.addEventListener('drop', function(e) {
            e.preventDefault();
        });

        function removeImage(questionNumber, type, buttonElement, imageIndex = null) {
            if (!confirm('Are you sure you want to remove this image?')) {
                return;
            }
            
            const imageDiv = buttonElement.parentElement;
            const question = allQuestions.find(q => q.number === questionNumber);
            
            if (!question) {
                console.error('Question not found:', questionNumber);
                return;
            }
            
            // Get the image URL for Firebase deletion
            const imgElement = imageDiv.querySelector('img');
            const imageUrl = imgElement ? imgElement.src : null;
            
            // Remove from Firebase if it's a Firebase URL
            if (imageUrl && imageUrl.includes('firebasestorage.googleapis.com')) {
                const { storage, ref, deleteObject } = window.firebaseStorage;
                if (storage && ref && deleteObject) {
                    // Extract the file path from the URL
                    const urlParts = imageUrl.split('/');
                    const fileName = urlParts[urlParts.length - 1].split('?')[0];
                    const currentSubject = getCurrentSubject();
                    const year = '2025';
                    const storagePath = `questions/${currentSubject}/${year}/${fileName}`;
                    
                    const storageRef = ref(storage, storagePath);
                    deleteObject(storageRef).catch(error => {
                        console.error('Failed to delete from Firebase:', error);
                    });
                }
            }
            
            // Remove from DOM
            imageDiv.remove();
            
            // Remove from question object
            if (type === 'question' && question.questionImages) {
                if (imageIndex !== null && imageIndex >= 0) {
                    question.questionImages.splice(imageIndex, 1);
                } else {
                    // Fallback: find by URL
                    const index = question.questionImages.findIndex(url => url === imageUrl);
                    if (index > -1) {
                        question.questionImages.splice(index, 1);
                    }
                }
            } else if (type === 'option' && question.optionImages && imageIndex !== null) {
                delete question.optionImages[imageIndex];
            } else if (type === 'solution' && question.solutionImages) {
                if (imageIndex !== null && imageIndex >= 0) {
                    question.solutionImages.splice(imageIndex, 1);
                } else {
                    // Fallback: find by URL
                    const index = question.solutionImages.findIndex(url => url === imageUrl);
                    if (index > -1) {
                        question.solutionImages.splice(index, 1);
                    }
                }
            }
            
            // Update Live Preview
            updateLivePreview();
        }
        
        // Initialize metadata editors for all subjects
        function initializeMetadataEditors() {
            const subjects = ['', '-physics', '-chemistry'];
            
            subjects.forEach(suffix => {
                const stateSelect = document.getElementById(`state${suffix}`);
                const boardSelect = document.getElementById(`board${suffix}`);
                const yearSelect = document.getElementById(`year${suffix}`);
                const subjectSelect = document.getElementById(`subject${suffix}`);
                const tutorialTitleInput = document.getElementById(`tutorialTitle${suffix}`);
                const authorityExamIdInput = document.getElementById(`authorityExamId${suffix}`);
                
                if (stateSelect && boardSelect && yearSelect && subjectSelect) {
                    // Add event listeners for dropdowns
                    stateSelect.addEventListener('change', () => updateMetadata(suffix));
                    boardSelect.addEventListener('change', () => updateMetadata(suffix));
                    yearSelect.addEventListener('change', () => updateMetadata(suffix));
                    subjectSelect.addEventListener('change', () => updateMetadata(suffix));
                    
                    // Add event listeners for manual input fields
                    if (tutorialTitleInput) {
                        tutorialTitleInput.addEventListener('input', () => updateJSONInRealTime(suffix));
                    }
                    if (authorityExamIdInput) {
                        authorityExamIdInput.addEventListener('input', () => updateJSONInRealTime(suffix));
                    }
                    
                    // Initial update
                    updateMetadata(suffix);
                }
            });
        }
        
        // Update metadata based on selections
        function updateMetadata(suffix) {
            const state = document.getElementById(`state${suffix}`).value;
            const board = document.getElementById(`board${suffix}`).value;
            const year = document.getElementById(`year${suffix}`).value;
            const subject = document.getElementById(`subject${suffix}`).value;
            
            // Update conducted by based on board
            const conductedByInput = document.getElementById(`conductedBy${suffix}`);
            if (conductedByInput) {
                conductedByInput.value = getConductedBy(board);
            }
            
            // Update authority exam ID
            const authorityExamIdInput = document.getElementById(`authorityExamId${suffix}`);
            if (authorityExamIdInput) {
                authorityExamIdInput.value = getAuthorityExamId(state, board);
            }
            
            // Update tutorial ID
            const tutorialIdInput = document.getElementById(`tutorialId${suffix}`);
            if (tutorialIdInput && board && year && subject) {
                tutorialIdInput.value = `${board}_${year}_${subject}`;
            }
            
            // Update tutorial title
            const tutorialTitleInput = document.getElementById(`tutorialTitle${suffix}`);
            if (tutorialTitleInput && board && year && subject) {
                tutorialTitleInput.value = `${board} ${year} ${subject}`;
            }
            
            // Trigger real-time JSON update
            updateJSONInRealTime(suffix);
        }
        
        // Update JSON in real-time when metadata changes
        function updateJSONInRealTime(suffix) {
            // Determine which subject this corresponds to
            let subject = '';
            if (suffix === '') subject = 'Mathematics';
            else if (suffix === '-physics') subject = 'Physics';
            else if (suffix === '-chemistry') subject = 'Chemistry';
            
            // Check if this subject is currently active and JSON viewer is open
            const jsonPanel = document.getElementById(`jsonViewer-${subject}`);
            if (jsonPanel && jsonPanel.style.display !== 'none') {
                // Regenerate JSON content with updated metadata
                generateJSONContent(subject);
            }
        }
        
        // Get conducted by based on board
        function getConductedBy(board) {
            const conductedByMap = {
                'KCET': 'KEA (Karnataka Examinations Authority)',
                'NEET': 'NTA (National Testing Agency)',
                'JEE Main': 'NTA (National Testing Agency)',
                'JEE Advanced': 'IITs via JAB',
                'MH-CET': 'DTE Maharashtra',
                'TN-Board': 'Tamil Nadu Board of Secondary Education'
            };
            return conductedByMap[board] || '';
        }
        
        // Get authority exam ID based on state and board
        function getAuthorityExamId(state, board) {
            const examIdMap = {
                'Karnataka': {
                    'KCET': 'kar_kect',
                    'NEET': 'nta_neet',
                    'JEE Main': 'nta_jee_main',
                    'JEE Advanced': 'iit_jee_advanced'
                },
                'Maharashtra': {
                    'MH-CET': 'mhcet',
                    'NEET': 'nta_neet',
                    'JEE Main': 'nta_jee_main',
                    'JEE Advanced': 'iit_jee_advanced'
                },
                'Tamil Nadu': {
                    'TN-Board': 'tn_board',
                    'NEET': 'nta_neet',
                    'JEE Main': 'nta_jee_main',
                    'JEE Advanced': 'iit_jee_advanced'
                },
                'Center': {
                    'NEET': 'nta_neet',
                    'JEE Main': 'nta_jee_main',
                    'JEE Advanced': 'iit_jee_advanced'
                }
            };
            return examIdMap[state]?.[board] || '';
        }
        
        // Auto-detect question type based on content
        function detectQuestionType(question) {
            const text = question.text || '';
            const options = question.options || [];
            
            // Check for fill in the blank
            if (text.includes('____') || text.includes('______') || text.includes('_ _ _ _') || text.includes('$\_\_\_\_$')) {
                return 'fillblank';
            }
            
            // Check for true/false (only 2 options)
            if (options.length === 2) {
                const optionTexts = options.map(opt => opt.replace(/^\(\d+\)\s*/, '').trim().toLowerCase());
                if (optionTexts.includes('true') && optionTexts.includes('false')) {
                    return 'truefalse';
                }
            }
            
            // Check for integer type (numeric answer expected)
            if (text.toLowerCase().includes('integer') || 
                text.toLowerCase().includes('numerical') ||
                text.toLowerCase().includes('number')) {
                return 'integer';
            }
            
            // Default to MCQ if options A, B, C, D have values
            const hasOptions = options.length >= 4 && 
                              options[0] && options[0].replace(/^\(\d+\)\s*/, '').trim() &&
                              options[1] && options[1].replace(/^\(\d+\)\s*/, '').trim() &&
                              options[2] && options[2].replace(/^\(\d+\)\s*/, '').trim() &&
                              options[3] && options[3].replace(/^\(\d+\)\s*/, '').trim();
            
            return hasOptions ? 'mcq' : 'fillblank';
        }
        
        // Update question type when question content changes
        function updateQuestionType(questionNumber) {
            const question = allQuestions.find(q => q.number === questionNumber);
            if (question) {
                const detectedType = detectQuestionType(question);
                if (!question.type || question.type === 'mcq') { // Only auto-detect if no type set or default MCQ
                    question.type = detectedType;
                }
            }
        }
        
        // Initialize when page loads
        window.addEventListener('load', function() {
            initializeMetadataEditors();
        });
    </script>
        </div> <!-- Close main-content -->
    </div> <!-- Close container -->
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Question Subject Assigner</title>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']],
                displayMath: [['$$', '$$'], ['\\[', '\\]']]
            }
        };
    </script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: #f5f5f5;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 10px;
        }
        
        .upload-section {
            border: 2px dashed #ddd;
            padding: 30px;
            text-align: center;
            margin-bottom: 30px;
            border-radius: 10px;
            background: #fafafa;
        }
        
        .file-input {
            display: none;
        }
        
        .upload-btn {
            background: #4facfe;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px;
        }
        
        .upload-btn:hover {
            background: #00f2fe;
        }
        
        .stats {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }
        
        .stat-card {
            background: #e8f4fd;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            min-width: 120px;
        }
        
        .stat-number {
            font-size: 24px;
            font-weight: bold;
            color: #4facfe;
        }
        
        .stat-label {
            color: #666;
            font-size: 14px;
        }
        
        .questions-container {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
            height: 70vh;
        }
        
        .questions-grid {
            flex: 1;
            overflow-y: auto;
            padding-right: 10px;
        }
        
        .questions-list {
            display: grid;
            grid-template-columns: 1fr;
            gap: 15px;
        }
        
        .render-panel {
            flex: 1;
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 10px;
            padding: 20px;
            overflow-y: auto;
            position: relative;
        }
        
        .render-label {
            position: absolute;
            top: -12px;
            right: 0px;
            background: white;
            padding: 2px 12px;
            font-size: 12px;
            color: #666;
            font-weight: 500;
            z-index: 1;
            white-space: nowrap;
        }
        
        .render-header {
            display: none;
        }
        
        .question-card {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            background: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .question-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
            border-color: #4facfe;
        }
        
        .question-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .question-number {
            background: #4facfe;
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            font-weight: bold;
        }
        
        .subject-selector {
            padding: 5px 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background: white;
        }
        
        .question-text {
            margin-bottom: 10px;
            line-height: 1.4;
            color: #333;
        }
        
        .question-options {
            margin-bottom: 10px;
        }
        
        .option {
            margin: 3px 0;
            padding: 3px 8px;
            background: #f8f9fa;
            border-radius: 3px;
            font-size: 14px;
        }
        
        .answer {
            font-weight: bold;
            color: #28a745;
            margin-top: 5px;
        }
        
        .actions {
            text-align: center;
            margin-top: 30px;
        }
        
        .btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 0 10px;
        }
        
        .btn:hover {
            background: #218838;
        }
        
        .btn-secondary {
            background: #6c757d;
        }
        
        .btn-secondary:hover {
            background: #5a6268;
        }
        
        .subject-assignments {
            margin-top: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 5px;
        }
        
        .subject-group {
            margin: 10px 0;
        }
        
        .subject-title {
            font-weight: bold;
            color: #4facfe;
            margin-bottom: 5px;
        }
        
        .question-list {
            color: #666;
            font-size: 14px;
        }
        
        .tab-btn {
            background: none;
            border: none;
            padding: 12px 24px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            color: #666;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
        }
        
        .tab-btn:hover {
            color: #4facfe;
            background: #f8f9fa;
        }
        
        .tab-btn.active {
            color: #4facfe;
            border-bottom-color: #4facfe;
            background: #f8f9fa;
        }
        
        .subject-questions {
            display: none;
        }
        
        .subject-questions.active {
            display: block;
        }
        
        .subject-view {
            display: none;
        }
        
        .subject-view.active {
            display: block;
        }
        
        .split-container {
            display: flex;
            gap: 20px;
            height: 70vh;
            margin-top: 20px;
        }
        
        .json-panel {
            flex: 1;
            background: #f8f9fa;
            border: 1px solid #e0e0e0;
            border-radius: 10px;
            padding: 20px;
            overflow-y: auto;
        }
        
        .render-panel {
            flex: 1;
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 10px;
            padding: 20px;
            overflow-y: auto;
            position: relative;
        }
        
        .render-label {
            position: absolute;
            top: -12px;
            right: 0px;
            background: white;
            padding: 2px 12px;
            font-size: 12px;
            color: #666;
            font-weight: 500;
            z-index: 1;
            white-space: nowrap;
        }
        
        .render-header {
            display: none;
        }
        
        .json-header {
            background: #4facfe;
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            text-align: center;
        }
        
        .render-header {
            background: #28a745;
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            text-align: center;
        }
        
        .question-render {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .question-render h4 {
            color: #4facfe;
            margin-bottom: 10px;
        }
        
        .options-render {
            margin: 10px 0;
        }
        
        .option-render {
            margin: 5px 0;
            padding: 8px;
            background: #f8f9fa;
            border-radius: 5px;
        }
        
        .answer-render {
            color: #28a745;
            font-weight: bold;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìö Question Subject Assigner</h1>
            <p>Upload your markdown file and assign questions to correct subjects</p>
        </div>
        
        <div class="upload-section">
            <h3>üìÅ Upload Markdown File</h3>
            <p>Select your .md file containing the questions</p>
            <input type="file" id="fileInput" class="file-input" accept=".md,.txt">
            <button class="upload-btn" onclick="document.getElementById('fileInput').click()">
                Choose File
            </button>
        </div>
        
        <div class="stats" id="stats" style="display: none;">
            <div class="stat-card">
                <div class="stat-number" id="totalQuestions">0</div>
                <div class="stat-label">Total Questions</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="mathQuestions">0</div>
                <div class="stat-label">Mathematics</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="physicsQuestions">0</div>
                <div class="stat-label">Physics</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="chemistryQuestions">0</div>
                <div class="stat-label">Chemistry</div>
            </div>
        </div>

        <!-- Subject Tabs -->
        <div id="subjectTabs" style="display: none; margin-bottom: 20px;">
            <div style="display: flex; border-bottom: 2px solid #e0e0e0; margin-bottom: 20px;">
                <button class="tab-btn active" onclick="showSubject('all')" id="tab-all">All Questions</button>
                <button class="tab-btn" onclick="showSubject('Mathematics')" id="tab-Mathematics">Mathematics</button>
                <button class="tab-btn" onclick="showSubject('Physics')" id="tab-Physics">Physics</button>
                <button class="tab-btn" onclick="showSubject('Chemistry')" id="tab-Chemistry">Chemistry</button>
            </div>
        </div>
        
        <div id="questionsContainer" style="display: none;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3>üìù Questions Found</h3>
                <h3>üìñ Render View</h3>
            </div>
            <div class="questions-container">
                <div class="questions-grid">
                    <div class="questions-list" id="questionsList">
                        <!-- Questions will be populated here -->
                    </div>
                </div>
                <div class="render-panel">
                    <div id="allQuestionsRender">
                        <p>Select a question to view its rendered content with MathJax.</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Subject Views -->
        <div id="subjectView-Mathematics" class="subject-view">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3>üìê Mathematics Questions</h3>
                <h3>üìñ Render View</h3>
            </div>
            <div class="questions-container">
                <div class="questions-grid">
                    <div class="questions-list" id="mathQuestionsList">
                        <!-- Mathematics questions will be populated here -->
                    </div>
                </div>
                <div class="render-panel">
                    <div id="mathRender">
                        <p>Select a question to view its rendered content with MathJax.</p>
                    </div>
                </div>
            </div>
        </div>

        <div id="subjectView-Physics" class="subject-view">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3>‚ö° Physics Questions</h3>
                <h3>üìñ Render View</h3>
            </div>
            <div class="questions-container">
                <div class="questions-grid">
                    <div class="questions-list" id="physicsQuestionsList">
                        <!-- Physics questions will be populated here -->
                    </div>
                </div>
                <div class="render-panel">
                    <div id="physicsRender">
                        <p>Select a question to view its rendered content with MathJax.</p>
                    </div>
                </div>
            </div>
        </div>

        <div id="subjectView-Chemistry" class="subject-view">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3>üß™ Chemistry Questions</h3>
                <h3>üìñ Render View</h3>
            </div>
            <div class="questions-container">
                <div class="questions-grid">
                    <div class="questions-list" id="chemistryQuestionsList">
                        <!-- Chemistry questions will be populated here -->
                    </div>
                </div>
                <div class="render-panel">
                    <div id="chemistryRender">
                        <p>Select a question to view its rendered content with MathJax.</p>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="actions" id="actions" style="display: none;">
            <h3>üìÑ Generate JSON Files</h3>
            <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 20px;">
                <button class="btn" onclick="generateSubjectJSON('Mathematics')">üìê Mathematics JSON</button>
                <button class="btn" onclick="generateSubjectJSON('Physics')">‚ö° Physics JSON</button>
                <button class="btn" onclick="generateSubjectJSON('Chemistry')">üß™ Chemistry JSON</button>
                <button class="btn btn-secondary" onclick="generateAllJSON()">üìö All Subjects JSON</button>
            </div>
            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                <button class="btn btn-secondary" onclick="downloadAssignments()">Download Assignments</button>
                <button class="btn btn-secondary" onclick="resetAssignments()">Reset All</button>
            </div>
        </div>
        
        <div id="subjectAssignments" style="display: none;">
            <h3>üìä Current Assignments</h3>
            <div id="assignmentsList">
                <!-- Assignments will be shown here -->
            </div>
        </div>
        
        <div id="debugInfo" style="display: none; margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 5px; border: 1px solid #e9ecef;">
            <h3>üîç Debug Information</h3>
            <div id="debugContent" style="font-family: monospace; font-size: 12px; max-height: 300px; overflow-y: auto;">
                <!-- Debug content will be shown here -->
            </div>
        </div>
    </div>

    <script>
        let allQuestions = [];
        let questionAssignments = {};
        
        document.getElementById('fileInput').addEventListener('change', handleFileSelect);
        
        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const content = e.target.result;
                    parseQuestions(content);
                };
                reader.readAsText(file);
            }
        }
        
        function parseQuestions(content) {
            console.log('Parsing questions from content...');
            
            const lines = content.split('\n');
            const questions = [];
            let currentQuestion = null;
            let currentSubject = '';
            let debugContent = '';
            
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i];
                
                // Check for section breaks
                if (line.includes('## MATHEMATICS') || line.includes('## PHYSICS') || line.includes('## CHEMISTRY')) {
                    currentSubject = line.replace('## ', '').toLowerCase();
                    console.log(`Line ${i+1}: Found section: ${currentSubject}`);
                    debugContent += `<div style="color: #007bff; margin: 2px 0;">Line ${i+1}: Found section: ${currentSubject}</div>`;
                    continue;
                }
                
                // Check if line starts with integer number followed by dot - this is a new question
                // Format: New Line + Integer Number + Dot + (optional space/newline) + Content
                // This prevents matching decimal numbers like "0.1 mol" or "2.5 cm"
                let questionMatch = line.match(/^(\d+)\.\s*(.*)/);
                
                // Additional check: make sure it's not a decimal number
                // If the character after the dot is a digit, it's a decimal, not a question
                if (questionMatch && line.match(/^\d+\.\d/)) {
                    // This is a decimal number, not a question
                    debugContent += `<div style="color: #ffc107; margin: 2px 0;">Line ${i+1}: Ignored decimal number: ${line.substring(0, 50)}...</div>`;
                    questionMatch = null;
                }
                
                // Debug: show what we're checking for potential questions
                if (line.match(/^\d/)) {
                    debugContent += `<div style="color: #6c757d; margin: 2px 0;">Line ${i+1}: Checking line starting with number: ${line.substring(0, 50)}...</div>`;
                }
                
                if (questionMatch) {
                    console.log(`Line ${i+1}: Found question ${questionMatch[1]}: ${questionMatch[2].substring(0, 50)}...`);
                    debugContent += `<div style="color: #28a745; margin: 2px 0; font-weight: bold;">Line ${i+1}: Found question ${questionMatch[1]}: ${questionMatch[2].substring(0, 100)}...</div>`;
                    
                    // Save previous question if it exists
                    if (currentQuestion) {
                        questions.push(currentQuestion);
                    }
                    
                    // Start new question - collect ALL content until next question
                    currentQuestion = {
                        number: questionMatch[1],
                        text: questionMatch[2],
                        options: [],
                        answer: '',
                        solution: '',
                        subject: currentSubject || 'unassigned',
                        fullContent: line + '\n'  // Start with the question line itself
                    };
                } else if (currentQuestion) {
                    // This line is part of the current question content
                    currentQuestion.fullContent += line + '\n';
                    
                    // Try to extract options
                    const optionMatch = line.match(/^\(([1-4])\)\s*(.*)/);
                    if (optionMatch) {
                        currentQuestion.options.push({
                            number: optionMatch[1],
                            text: optionMatch[2]
                        });
                        debugContent += `<div style="color: #6c757d; margin: 2px 0;">Line ${i+1}: Found option: ${line}</div>`;
                    }
                    
                    // Try to extract answer
                    const answerMatch = line.match(/Ans\.\s*\(([1-4])\)/);
                    if (answerMatch) {
                        currentQuestion.answer = answerMatch[1];
                        debugContent += `<div style="color: #dc3545; margin: 2px 0;">Line ${i+1}: Found answer: ${line}</div>`;
                    }
                    
                    // Try to extract solution
                    if (line.startsWith('Sol.')) {
                        currentQuestion.solution = line.substring(4).trim();
                        debugContent += `<div style="color: #ffc107; margin: 2px 0;">Line ${i+1}: Found solution: ${line.substring(0, 50)}...</div>`;
                    }
                }
            }
            
            // Don't forget the last question
            if (currentQuestion) {
                questions.push(currentQuestion);
            }
            
            // No filtering - if it starts with number. it's a question
            debugContent += `<div style="color: #007bff; font-weight: bold; margin: 10px 0; font-size: 16px;">Total questions found: ${questions.length}</div>`;
            debugContent += `<div style="color: #28a745; font-weight: bold; margin: 5px 0;">Question numbers: ${questions.map(q => q.number).join(', ')}</div>`;
            
            // Show which question numbers are missing or extra
            const questionNumbers = questions.map(q => parseInt(q.number)).sort((a, b) => a - b);
            const expectedNumbers = Array.from({length: 75}, (_, i) => i + 1);
            const missing = expectedNumbers.filter(n => !questionNumbers.includes(n));
            const extra = questionNumbers.filter(n => n > 75 || n < 1);
            
            debugContent += `<div style="color: #6c757d; margin: 5px 0;">Found question numbers: ${questionNumbers.join(', ')}</div>`;
            debugContent += `<div style="color: #6c757d; margin: 5px 0;">Expected question numbers: 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31, 32, 33, 34, 35, 36, 37, 38, 39, 40, 41, 42, 43, 44, 45, 46, 47, 48, 49, 50, 51, 52, 53, 54, 55, 56, 57, 58, 59, 60, 61, 62, 63, 64, 65, 66, 67, 68, 69, 70, 71, 72, 73, 74, 75</div>`;
            
            if (missing.length > 0) {
                debugContent += `<div style="color: #dc3545; font-weight: bold; margin: 5px 0;">Missing question numbers: ${missing.join(', ')}</div>`;
            }
            if (extra.length > 0) {
                debugContent += `<div style="color: #dc3545; font-weight: bold; margin: 5px 0;">Extra question numbers: ${extra.join(', ')}</div>`;
            }
            
            // Show debug info
            document.getElementById('debugContent').innerHTML = debugContent;
            document.getElementById('debugInfo').style.display = 'block';
            
            console.log(`Found ${questions.length} questions`);
            console.log('Question numbers:', questions.map(q => q.number).join(', '));
            allQuestions = questions;
            displayQuestions();
            updateStats();
        }
        
        function displayQuestions() {
            const container = document.getElementById('questionsList');
            container.innerHTML = '';
            
            allQuestions.forEach((question, index) => {
                const questionCard = document.createElement('div');
                questionCard.className = 'question-card';
                questionCard.onclick = () => scrollToQuestion(question.number, 'all');
                
                const optionsHtml = question.options.map(opt => 
                    `<div class="option">(${opt.number}) ${opt.text}</div>`
                ).join('');
                
                // Set the selected value based on the detected subject
                const selectedSubject = question.subject === 'unassigned' ? '' : question.subject.charAt(0).toUpperCase() + question.subject.slice(1);
                
                questionCard.innerHTML = `
                    <div class="question-header">
                        <div class="question-number">Q${question.number}</div>
                        <select class="subject-selector" onchange="assignSubject(${index}, this.value); event.stopPropagation();">
                            <option value="">Select Subject</option>
                            <option value="Mathematics" ${selectedSubject === 'Mathematics' ? 'selected' : ''}>Mathematics</option>
                            <option value="Physics" ${selectedSubject === 'Physics' ? 'selected' : ''}>Physics</option>
                            <option value="Chemistry" ${selectedSubject === 'Chemistry' ? 'selected' : ''}>Chemistry</option>
                        </select>
                    </div>
                    <div class="question-text">${question.text}</div>
                    <div class="question-options">${optionsHtml}</div>
                    ${question.answer ? `<div class="answer">Answer: (${question.answer})</div>` : ''}
                    ${question.subject !== 'unassigned' ? `<div class="answer" style="color: #4facfe;">Detected Subject: ${selectedSubject}</div>` : ''}
                `;
                
                container.appendChild(questionCard);
            });
            
            // Render all questions in the right panel
            renderAllQuestions('all');
            
            document.getElementById('questionsContainer').style.display = 'block';
            document.getElementById('subjectTabs').style.display = 'block';
            document.getElementById('actions').style.display = 'block';
        }
        
        function assignSubject(questionIndex, subject) {
            const question = allQuestions[questionIndex];
            questionAssignments[question.number] = subject;
            updateStats();
            updateAssignmentsDisplay();
        }
        
        function updateStats() {
            const total = allQuestions.length;
            
            // Count questions by subject (assigned or detected)
            const math = allQuestions.filter(q => {
                const assignedSubject = questionAssignments[q.number];
                const detectedSubject = q.subject;
                return assignedSubject === 'Mathematics' || 
                       (detectedSubject === 'mathematics' && !assignedSubject) ||
                       (detectedSubject === 'mathematics');
            }).length;
            
            const physics = allQuestions.filter(q => {
                const assignedSubject = questionAssignments[q.number];
                const detectedSubject = q.subject;
                return assignedSubject === 'Physics' || 
                       (detectedSubject === 'physics' && !assignedSubject) ||
                       (detectedSubject === 'physics');
            }).length;
            
            const chemistry = allQuestions.filter(q => {
                const assignedSubject = questionAssignments[q.number];
                const detectedSubject = q.subject;
                return assignedSubject === 'Chemistry' || 
                       (detectedSubject === 'chemistry' && !assignedSubject) ||
                       (detectedSubject === 'chemistry');
            }).length;
            
            document.getElementById('totalQuestions').textContent = total;
            document.getElementById('mathQuestions').textContent = math;
            document.getElementById('physicsQuestions').textContent = physics;
            document.getElementById('chemistryQuestions').textContent = chemistry;
            
            document.getElementById('stats').style.display = 'flex';
        }
        
        function updateAssignmentsDisplay() {
            const assignmentsList = document.getElementById('assignmentsList');
            const subjects = ['Mathematics', 'Physics', 'Chemistry'];
            
            let html = '';
            subjects.forEach(subject => {
                const questions = Object.entries(questionAssignments)
                    .filter(([num, sub]) => sub === subject)
                    .map(([num]) => num)
                    .sort((a, b) => parseInt(a) - parseInt(b));
                
                html += `
                    <div class="subject-group">
                        <div class="subject-title">${subject} (${questions.length} questions)</div>
                        <div class="question-list">Questions: ${questions.join(', ')}</div>
                    </div>
                `;
            });
            
            assignmentsList.innerHTML = html;
            document.getElementById('subjectAssignments').style.display = 'block';
        }
        
        function generateJSON() {
            const subjects = ['Mathematics', 'Physics', 'Chemistry'];
            const result = {};
            
            subjects.forEach(subject => {
                const subjectQuestions = allQuestions
                    .filter(q => questionAssignments[q.number] === subject)
                    .map((q, index) => ({
                        questionIndex: (index + 1).toString(),
                        questionId: `Q${q.number}`,
                        questionDetails: [{
                            text: q.text,
                            textImages: [],
                            possibleAnswers: q.options.reduce((acc, opt) => {
                                const letter = String.fromCharCode(64 + parseInt(opt.number));
                                acc[letter] = { text: opt.text, image: null };
                                return acc;
                            }, {}),
                            correctAnswer: String.fromCharCode(64 + parseInt(q.answer)),
                            correctAnswerText: q.options.find(opt => opt.number === q.answer)?.text || ''
                        }],
                        subject: subject,
                        solution: q.solution,
                        marks: '4'
                    }));
                
                result[subject] = {
                    subject: subject,
                    totalQuestions: subjectQuestions.length,
                    questions: subjectQuestions
                };
            });
            
            console.log('Generated JSON:', result);
            
            // Show JSON in a new window
            const jsonWindow = window.open('', '_blank');
            jsonWindow.document.write(`
                <html>
                <head><title>Generated JSON</title></head>
                <body>
                    <h1>Generated JSON Output</h1>
                    <pre style="background: #f5f5f5; padding: 20px; border-radius: 5px; overflow-x: auto;">${JSON.stringify(result, null, 2)}</pre>
                </body>
                </html>
            `);
        }
        
        function downloadAssignments() {
            const data = {
                assignments: questionAssignments,
                questions: allQuestions.map(q => ({
                    number: q.number,
                    text: q.text,
                    subject: questionAssignments[q.number] || 'Unassigned'
                }))
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'question_assignments.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
        
        function resetAssignments() {
            questionAssignments = {};
            document.querySelectorAll('.subject-selector').forEach(select => {
                select.value = '';
            });
            updateStats();
            updateAssignmentsDisplay();
        }
        
        function showSubject(subject) {
            console.log(`Switching to subject: ${subject}`);
            
            // Update tab buttons
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.getElementById(`tab-${subject}`).classList.add('active');
            
            // Hide all subject views
            document.querySelectorAll('.subject-view').forEach(view => {
                view.classList.remove('active');
            });
            
            if (subject === 'all') {
                // Show all questions in grid view
                document.getElementById('questionsContainer').style.display = 'block';
                const questionCards = document.querySelectorAll('.question-card');
                questionCards.forEach(card => {
                    card.style.display = 'block';
                });
            } else {
                // Hide grid view and show subject split view
                document.getElementById('questionsContainer').style.display = 'none';
                
                const subjectViewElement = document.getElementById(`subjectView-${subject}`);
                console.log(`Looking for element: subjectView-${subject}`);
                console.log(`Element found:`, subjectViewElement);
                
                if (subjectViewElement) {
                    subjectViewElement.classList.add('active');
                    console.log(`Activated subject view for ${subject}`);
                    
                    // Generate and display questions for this subject
                    generateSubjectView(subject);
                } else {
                    console.error(`Element subjectView-${subject} not found!`);
                }
            }
        }
        
        function renderAllQuestions(context) {
            const renderElement = document.getElementById(context === 'all' ? 'allQuestionsRender' : 
                                                      context === 'Mathematics' ? 'mathRender' :
                                                      context === 'Physics' ? 'physicsRender' : 'chemistryRender');
            
            if (!renderElement) return;
            
            // Get questions to render
            let questionsToRender = allQuestions;
            if (context !== 'all') {
                questionsToRender = allQuestions.filter(q => {
                    const assignedSubject = questionAssignments[q.number];
                    const detectedSubject = q.subject;
                    return assignedSubject === context || 
                           (detectedSubject && detectedSubject.toLowerCase() === context.toLowerCase());
                });
            }
            
            let renderHtml = '';
            questionsToRender.forEach((question, index) => {
                const optionsHtml = question.options.map(opt => {
                    const letter = String.fromCharCode(64 + parseInt(opt.number));
                    return `<div class="option-render"><strong>${letter}.</strong> ${opt.text}</div>`;
                }).join('');
                
                const answerText = question.options.find(opt => opt.number === question.answer)?.text || '';
                const answerLetter = question.answer ? String.fromCharCode(64 + parseInt(question.answer)) : '';
                
                renderHtml += `
                    <div class="question-render" id="render-q${question.number}">
                        <h4>Question ${question.number}</h4>
                        <div class="question-text">${question.text}</div>
                        <div class="options-render">${optionsHtml}</div>
                        ${answerText ? `<div class="answer-render">Answer: ${answerLetter}. ${answerText}</div>` : ''}
                        <hr style="margin: 20px 0; border: 1px solid #eee;">
                    </div>
                `;
            });
            
            renderElement.innerHTML = renderHtml;
            
            // Re-render MathJax
            if (window.MathJax) {
                MathJax.typesetPromise([renderElement]).catch((err) => console.log('MathJax error:', err));
            }
        }
        
        function scrollToQuestion(questionNumber, context) {
            const renderElement = document.getElementById(context === 'all' ? 'allQuestionsRender' : 
                                                      context === 'Mathematics' ? 'mathRender' :
                                                      context === 'Physics' ? 'physicsRender' : 'chemistryRender');
            
            if (!renderElement) return;
            
            const targetElement = document.getElementById(`render-q${questionNumber}`);
            if (targetElement) {
                // Scroll the target question into view
                targetElement.scrollIntoView({ 
                    behavior: 'smooth', 
                    block: 'start',
                    inline: 'nearest'
                });
                
                // Add a highlight effect
                targetElement.style.backgroundColor = '#fff3cd';
                targetElement.style.border = '2px solid #ffc107';
                targetElement.style.borderRadius = '8px';
                targetElement.style.transition = 'all 0.3s ease';
                
                // Remove highlight after 2 seconds
                setTimeout(() => {
                    targetElement.style.backgroundColor = '';
                    targetElement.style.border = '';
                }, 2000);
            }
        }
        
        function generateSubjectView(subject) {
            // Get questions for this subject
            const subjectQuestions = allQuestions.filter(q => {
                const assignedSubject = questionAssignments[q.number];
                const detectedSubject = q.subject;
                
                return assignedSubject === subject || 
                       (detectedSubject && detectedSubject.toLowerCase() === subject.toLowerCase());
            });
            
            console.log(`Generating view for ${subject}: ${subjectQuestions.length} questions`);
            
            // Get the questions list container for this subject
            const questionsListId = subject === 'Mathematics' ? 'mathQuestionsList' :
                                   subject === 'Physics' ? 'physicsQuestionsList' : 'chemistryQuestionsList';
            const container = document.getElementById(questionsListId);
            
            if (!container) {
                console.error(`Container ${questionsListId} not found!`);
                return;
            }
            
            container.innerHTML = '';
            
            if (subjectQuestions.length === 0) {
                container.innerHTML = `<p>No questions found for ${subject}.</p>`;
                return;
            }
            
            // Create question cards for this subject
            subjectQuestions.forEach((question, index) => {
                const questionCard = document.createElement('div');
                questionCard.className = 'question-card';
                questionCard.onclick = () => scrollToQuestion(question.number, subject);
                
                const optionsHtml = question.options.map(opt => 
                    `<div class="option">(${opt.number}) ${opt.text}</div>`
                ).join('');
                
                questionCard.innerHTML = `
                    <div class="question-header">
                        <div class="question-number">Q${question.number}</div>
                    </div>
                    <div class="question-text">${question.text}</div>
                    <div class="question-options">${optionsHtml}</div>
                    ${question.answer ? `<div class="answer">Answer: (${question.answer})</div>` : ''}
                `;
                
                container.appendChild(questionCard);
            });
            
            // Render all questions for this subject in the right panel
            renderAllQuestions(subject);
        }
        
        function generateSubjectJSON(subject) {
            // Get questions assigned to this subject OR detected as this subject
            const subjectQuestions = allQuestions.filter(q => {
                const assignedSubject = questionAssignments[q.number];
                const detectedSubject = q.subject;
                return assignedSubject === subject || 
                       (detectedSubject === subject.toLowerCase() && !assignedSubject) ||
                       (detectedSubject === 'mathematics' && subject === 'Mathematics') ||
                       (detectedSubject === 'physics' && subject === 'Physics') ||
                       (detectedSubject === 'chemistry' && subject === 'Chemistry');
            });
            
            if (subjectQuestions.length === 0) {
                alert(`No questions assigned to ${subject}. Please assign some questions first.`);
                return;
            }
            
            const jsonData = [{
                "tutorialId": `JEE_2025_${subject}`,
                "tutorialTitle": `JEE 2025 ${subject}`,
                "tutorialDescription": `JEE (Main) 2025 ${subject} Questions`,
                "authorityExamId": "jee_main",
                "state": "All India",
                "board": "JEE",
                "conductedBy": "NTA (National Testing Agency)",
                "year": "2025",
                "subject": subject,
                "questions": subjectQuestions.map((q, index) => ({
                    "questionIndex": (index + 1).toString(),
                    "questionId": `2025${subject.charAt(0)}Q${q.number}`,
                    "questionDetails": [{
                        "text": q.text,
                        "textImages": [],
                        "possibleAnswers": q.options.reduce((acc, opt) => {
                            const letter = String.fromCharCode(64 + parseInt(opt.number));
                            acc[letter] = { 
                                "text": opt.text, 
                                "image": null 
                            };
                            return acc;
                        }, {}),
                        "correctAnswer": q.answer ? String.fromCharCode(64 + parseInt(q.answer)) : "",
                        "correctAnswerText": q.options.find(opt => opt.number === q.answer)?.text || ""
                    }]
                }))
            }];
            
            // Show JSON in a new window
            const jsonWindow = window.open('', '_blank');
            jsonWindow.document.write(`
                <html>
                <head>
                    <title>${subject} JSON - JEE 2025</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 20px; }
                        pre { background: #f5f5f5; padding: 20px; border-radius: 5px; overflow-x: auto; }
                        .header { background: #4facfe; color: white; padding: 20px; border-radius: 10px; margin-bottom: 20px; }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>${subject} Questions - JEE 2025</h1>
                        <p>Total Questions: ${subjectQuestions.length}</p>
                    </div>
                    <pre>${JSON.stringify(jsonData, null, 2)}</pre>
                </body>
                </html>
            `);
        }
        
        function generateAllJSON() {
            const subjects = ['Mathematics', 'Physics', 'Chemistry'];
            const allJsonData = [];
            
            subjects.forEach(subject => {
                // Get questions assigned to this subject OR detected as this subject
                const subjectQuestions = allQuestions.filter(q => {
                    const assignedSubject = questionAssignments[q.number];
                    const detectedSubject = q.subject;
                    return assignedSubject === subject || 
                           (detectedSubject === subject.toLowerCase() && !assignedSubject) ||
                           (detectedSubject === 'mathematics' && subject === 'Mathematics') ||
                           (detectedSubject === 'physics' && subject === 'Physics') ||
                           (detectedSubject === 'chemistry' && subject === 'Chemistry');
                });
                
                if (subjectQuestions.length > 0) {
                    allJsonData.push({
                        "tutorialId": `JEE_2025_${subject}`,
                        "tutorialTitle": `JEE 2025 ${subject}`,
                        "tutorialDescription": `JEE (Main) 2025 ${subject} Questions`,
                        "authorityExamId": "jee_main",
                        "state": "All India",
                        "board": "JEE",
                        "conductedBy": "NTA (National Testing Agency)",
                        "year": "2025",
                        "subject": subject,
                        "questions": subjectQuestions.map((q, index) => ({
                            "questionIndex": (index + 1).toString(),
                            "questionId": `2025${subject.charAt(0)}Q${q.number}`,
                            "questionDetails": [{
                                "text": q.text,
                                "textImages": [],
                                "possibleAnswers": q.options.reduce((acc, opt) => {
                                    const letter = String.fromCharCode(64 + parseInt(opt.number));
                                    acc[letter] = { 
                                        "text": opt.text, 
                                        "image": null 
                                    };
                                    return acc;
                                }, {}),
                                "correctAnswer": q.answer ? String.fromCharCode(64 + parseInt(q.answer)) : "",
                                "correctAnswerText": q.options.find(opt => opt.number === q.answer)?.text || ""
                            }]
                        }))
                    });
                }
            });
            
            // Show JSON in a new window
            const jsonWindow = window.open('', '_blank');
            jsonWindow.document.write(`
                <html>
                <head>
                    <title>All Subjects JSON - JEE 2025</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 20px; }
                        pre { background: #f5f5f5; padding: 20px; border-radius: 5px; overflow-x: auto; }
                        .header { background: #4facfe; color: white; padding: 20px; border-radius: 10px; margin-bottom: 20px; }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>All Subjects - JEE 2025</h1>
                        <p>Total Subjects: ${allJsonData.length}</p>
                    </div>
                    <pre>${JSON.stringify(allJsonData, null, 2)}</pre>
                </body>
                </html>
            `);
        }
    </script>
</body>
</html>
